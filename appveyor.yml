version: '0.5.0-{build}'

branches:
  only:
    - master
    - development
    - /^v\d+\.\d+(\.\d+)?(-\S*)?$/

skip_commits:
  files:
    - '*.md'
    - COPYING

environment:
  auth_token:
    secure: rLuHhO0prerqoGCYmfOoyxqcwwamCXtuZtl4Jzqeu3aGgflk0mnX1fogLq68YcRW
  matrix:
    - prepare_mode: YES
      name: win32-prepare
      platform: amd64_x86
      qt: msvc2015
    - prepare_mode: NO
      name: win32
      platform: amd64_x86
      qt: msvc2015
    - prepare_mode: NO
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
      name: win64
      platform: amd64
      qt: msvc2017_64
    - prepare_mode: NO
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2013
      name: win32
      platform: mingw
      qt: mingw492_32

clone_folder: c:\dev\quentier

init:
  - if not %platform%==mingw set PATH=C:\Qt\5.10\%qt%\bin;%PATH%
  - if %platform%==mingw set PATH=C:\Qt\5.5\%qt%\bin;%PATH%
  - set ORIGPATH=%PATH%
  - if %platform%==amd64 set tool=VS2017_x64
  - if %platform%==amd64_x86 set tool=VS2015_x86
  - if %platform%==mingw set tool=MinGW_x86
  - if %platform%==mingw set DEPLOYMENT_TARGET=Quentier-0.5.0-windows-portable-qt55-%tool%.zip
  - if not %platform%==mingw set DEPLOYMENT_TARGET=Quentier-0.5.0-windows-portable-qt510-%tool%.zip
  - if %platform%==amd64 call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars64.bat"
  - if %platform%==amd64_x86 call "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" %platform%
  - if not %platform%==mingw (set makefiles="NMake Makefiles") else (set makefiles="MinGW Makefiles")
  - if %platform%==mingw (set use_webkit=1) else (set use_webkit=0)
  - if %platform%==mingw set PATH=C:\MinGW\bin;C:\Program Files (x86)\CMake\bin;%PATH%
  - if %qt%==msvc2017_64 set PATH="C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\MSBuild\15.0\Bin";%PATH%
  - if %qt%==msvc2015 set PATH="C:\Program Files (x86)\MSBuild\14.0\Bin";%PATH%

install:
  - if not exist c:\dev\ciuploadtool (md c:\dev\ciuploadtool) else (echo "Using cached version of ciuploadtool")
  - cd c:\dev\ciuploadtool
  - if not exist c:\dev\ciuploadtool\ciuploadtool.exe echo "Downloading ciuploadtool"
  - if not exist c:\dev\ciuploadtool\ciuploadtool.exe curl -fsSL https://github.com/d1vanov/ciuploadtool/releases/download/continuous-master/ciuploadtool_windows_x86.zip -o ciuploadtool_windows_x86.zip
  - if not exist c:\dev\ciuploadtool\ciuploadtool.exe 7z x ciuploadtool_windows_x86.zip
  - if %prepare_mode%==YES c:\dev\ciuploadtool\ciuploadtool.exe -preponly -suffix="%APPVEYOR_REPO_BRANCH%"
  - ps: if ($env:prepare_mode -eq "YES") { throw "Failing in order to stop the current build matrix job early" }
# libiconv
  - if not exist c:\dev\libiconv (set SHOULD_DOWNLOAD_LIBICONV=1) else (set SHOULD_DOWNLOAD_LIBICONV=0)
  - if %SHOULD_DOWNLOAD_LIBICONV%==1 (md c:\dev\libiconv) else (echo "Using cached version of libiconv")
  - cd c:\dev\libiconv
  - if %SHOULD_DOWNLOAD_LIBICONV%==1 echo "Downloading libiconv"
  - if %SHOULD_DOWNLOAD_LIBICONV%==1 if %qt%==msvc2015 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/libiconv-1.15-msvc2015_x86.zip -o libiconv-1.15-msvc2015_x86.zip
  - if %qt%==msvc2015 7z x libiconv-1.15-msvc2015_x86.zip
  - if %SHOULD_DOWNLOAD_LIBICONV%==1 if %qt%==msvc2017_64 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/libiconv-1.15-msvc2017_x64.zip -o libiconv-1.15-msvc2017_x64.zip
  - if %qt%==msvc2017_64 7z x libiconv-1.15-msvc2017_x64.zip
  - if %SHOULD_DOWNLOAD_LIBICONV%==1 if %qt%==mingw492_32 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/libiconv-1.15-mingw530_x86.zip -o libiconv-1.15-mingw530_x86.zip
  - if %qt%==mingw492_32 7z x libiconv-1.15-mingw530_x86.zip
  - set PATH=%cd%\bin;%PATH%
  - set LIB=%cd%\lib;%LIB%
  - set INCLUDE=%cd%\include;%INCLUDE%
# zlib
  - if not exist c:\dev\zlib (set SHOULD_DOWNLOAD_ZLIB=1) else (set SHOULD_DOWNLOAD_ZLIB=0)
  - if %SHOULD_DOWNLOAD_ZLIB%==1 (md c:\dev\zlib) else (echo "Using cached version of zlib")
  - cd c:\dev\zlib
  - if %SHOULD_DOWNLOAD_ZLIB%==1 echo "Downloading zlib"
  - if %SHOULD_DOWNLOAD_ZLIB%==1 if %qt%==msvc2015 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/zlib-1.2.11-msvc2015_x86.zip -o zlib-1.2.11-msvc2015_x86.zip
  - if %qt%==msvc2015 7z x zlib-1.2.11-msvc2015_x86.zip
  - if %SHOULD_DOWNLOAD_ZLIB%==1 if %qt%==msvc2017_64 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/zlib-1.2.11-msvc2017_x64.zip -o zlib-1.2.11-msvc2017_x64.zip
  - if %qt%==msvc2017_64 7z x zlib-1.2.11-msvc2017_x64.zip
  - if %SHOULD_DOWNLOAD_ZLIB%==1 if %qt%==mingw492_32 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/zlib-1.2.11-mingw530_x86.zip -o zlib-1.2.11-mingw530_x86.zip
  - if %qt%==mingw492_32 7z x zlib-1.2.11-mingw530_x86.zip
  - set PATH=%cd%\bin;%PATH%
  - set LIB=%cd%\lib;%LIB%
  - set INCLUDE=%cd%\include;%INCLUDE%
# libxml2
  - if not exist c:\dev\libxml2 (set SHOULD_DOWNLOAD_LIBXML2=1) else (set SHOULD_DOWNLOAD_LIBXML2=0)
  - if %SHOULD_DOWNLOAD_LIBXML2%==1 (md c:\dev\libxml2) else (echo "Using cached version of libxml2")
  - cd c:\dev\libxml2
  - if %SHOULD_DOWNLOAD_LIBXML2%==1 echo "Downloading libxml2"
  - if %SHOULD_DOWNLOAD_LIBXML2%==1 if %qt%==msvc2015 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/libxml2-2.9.7-msvc2015_x86.zip -o libxml2-2.9.7-msvc2015_x86.zip
  - if %qt%==msvc2015 7z x libxml2-2.9.7-msvc2015_x86.zip
  - if %SHOULD_DOWNLOAD_LIBXML2%==1 if %qt%==msvc2017_64 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/libxml2-2.9.7-msvc2017_x64.zip -o libxml2-2.9.7-msvc2017_x64.zip
  - if %qt%==msvc2017_64 7z x libxml2-2.9.7-msvc2017_x64.zip
  - if %SHOULD_DOWNLOAD_LIBXML2%==1 if %qt%==mingw492_32 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/libxml2-2.9.7-mingw530_x86.zip -o libxml2-2.9.7-mingw530_x86.zip
  - if %qt%==mingw492_32 7z x libxml2-2.9.7-mingw530_x86.zip
  - set PATH=%cd%\bin;%PATH%
  - set LIB=%cd%\lib;%LIB%
  - set INCLUDE=%cd%\include;%INCLUDE%
# libhunspell
  - if not exist c:\dev\libhunspell (set SHOULD_DOWNLOAD_LIBHUNSPELL=1) else (set SHOULD_DOWNLOAD_LIBHUNSPELL=0)
  - if %SHOULD_DOWNLOAD_LIBHUNSPELL%==1 (md c:\dev\libhunspell) else (echo "Using cached version of libhunspell")
  - cd c:\dev\libhunspell
  - if %SHOULD_DOWNLOAD_LIBHUNSPELL%==1 echo "Downloading libhunspell"
  - if %SHOULD_DOWNLOAD_LIBHUNSPELL%==1 if %qt%==msvc2015 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/libhunspell-1.7.0-msvc2015_x86.zip -o libhunspell-1.7.0-msvc2015_x86.zip
  - if %qt%==msvc2015 7z x libhunspell-1.7.0-msvc2015_x86.zip
  - if %SHOULD_DOWNLOAD_LIBHUNSPELL%==1 if %qt%==msvc2017_64 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/libhunspell-1.7.0-msvc2017_x64.zip -o libhunspell-1.7.0-msvc2017_x64.zip
  - if %qt%==msvc2017_64 7z x libhunspell-1.7.0-msvc2017_x64.zip
  - if %SHOULD_DOWNLOAD_LIBHUNSPELL%==1 if %qt%==mingw492_32 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/libhunspell-1.6.2-mingw530_x86.zip -o libhunspell-1.6.2-mingw530_x86.zip
  - if %qt%==mingw492_32 7z x libhunspell-1.6.2-mingw530_x86.zip
  - set PATH=%cd%\bin;%PATH%
  - set LIB=%cd%\lib;%LIB%
  - set INCLUDE=%cd%\include;%INCLUDE%
# tidy-html5
  - if not exist c:\dev\tidy-html5 (set SHOULD_DOWNLOAD_TIDY_HTML5=1) else (set SHOULD_DOWNLOAD_TIDY_HTML5=0)
  - if %SHOULD_DOWNLOAD_TIDY_HTML5%==1 (md c:\dev\tidy-html5) else (echo "Using cached version of tidy-html5")
  - cd c:\dev\tidy-html5
  - if %SHOULD_DOWNLOAD_TIDY_HTML5%==1 echo "Downloading tidy-html5"
  - if %SHOULD_DOWNLOAD_TIDY_HTML5%==1 if %qt%==msvc2015 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/tidy-html5-5.6.0-msvc2015_x86.zip -o tidy-html5-5.6.0-msvc2015_x86.zip
  - if %qt%==msvc2015 7z x tidy-html5-5.6.0-msvc2015_x86.zip
  - if %SHOULD_DOWNLOAD_TIDY_HTML5%==1 if %qt%==msvc2017_64 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/tidy-html5-5.6.0-msvc2017_x64.zip -o tidy-html5-5.6.0-msvc2017_x64.zip
  - if %qt%==msvc2017_64 7z x tidy-html5-5.6.0-msvc2017_x64.zip
  - if %SHOULD_DOWNLOAD_TIDY_HTML5%==1 if %qt%==mingw492_32 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/tidy-html5-5.6.0-mingw530_x86.zip -o tidy-html5-5.6.0-mingw530_x86.zip
  - if %qt%==mingw492_32 7z x tidy-html5-5.6.0-mingw530_x86.zip
  - set PATH=%cd%\bin;%PATH%
  - set LIB=%cd%\lib;%LIB%
  - set INCLUDE=%cd%\include;%INCLUDE%
# Boost
  - if not exist c:\dev\boost (set SHOULD_DOWNLOAD_BOOST=1) else (set SHOULD_DOWNLOAD_BOOST=0)
  - if %SHOULD_DOWNLOAD_BOOST%==1 (md c:\dev\boost) else (echo "Using cached version of boost")
  - cd c:\dev\boost
  - if %SHOULD_DOWNLOAD_BOOST%==1 echo "Downloading boost"
  - if %SHOULD_DOWNLOAD_BOOST%==1 if %qt%==msvc2015 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/boost-1_65_0-msvc2015_x86.zip -o boost-1_65_0-msvc2015_x86.zip
  - if %qt%==msvc2015 7z x boost-1_65_0-msvc2015_x86.zip
  - if %SHOULD_DOWNLOAD_BOOST%==1 if %qt%==msvc2017_64 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/boost-1_65_0-msvc2017_x64.zip -o boost-1_65_0-msvc2017_x64.zip
  - if %qt%==msvc2017_64 7z x boost-1_65_0-msvc2017_x64.zip
  - if %SHOULD_DOWNLOAD_BOOST%==1 if %qt%==mingw492_32 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/boost-1_65_0-mingw530_x86.zip -o boost-1_65_0-mingw530_x86.zip
  - if %qt%==mingw492_32 7z x boost-1_65_0-mingw530_x86.zip
  - set PATH=%cd%\bin;%PATH%
  - set LIB=%cd%\lib;%LIB%
  - set INCLUDE=%cd%\include;%INCLUDE%
  - set BOOST_ROOT=%cd%
# OpenSSL
  - if not exist c:\dev\openssl (set SHOULD_DOWNLOAD_OPENSSL=1) else (set SHOULD_DOWNLOAD_OPENSSL=0)
  - if %SHOULD_DOWNLOAD_OPENSSL%==1 (md c:\dev\openssl) else (echo "Using cached version of openssl")
  - cd c:\dev\openssl
  - if %SHOULD_DOWNLOAD_OPENSSL%==1 echo "Downloading OpenSSL"
  - if %SHOULD_DOWNLOAD_OPENSSL%==1 if %qt%==msvc2015 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/openssl-1_0_2r-msvc2015_x86.zip -o openssl-1_0_2r-msvc2015_x86.zip
  - if %qt%==msvc2015 7z x openssl-1_0_2r-msvc2015_x86.zip
  - if %SHOULD_DOWNLOAD_OPENSSL%==1 if %qt%==msvc2017_64 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/openssl-1_0_2r-msvc2017_x64.zip -o openssl-1_0_2r-msvc2017_x64.zip
  - if %qt%==msvc2017_64 7z x openssl-1_0_2r-msvc2017_x64.zip
  - if %SHOULD_DOWNLOAD_OPENSSL%==1 if %qt%==mingw492_32 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/openssl-1_0_2r-mingw530_x86.zip -o openssl-1_0_2r-mingw530_x86.zip
  - if %qt%==mingw492_32 7z x openssl-1_0_2r-mingw530_x86.zip
  - set PATH=%cd%\bin;%PATH%
  - set LIB=%cd%\lib;%LIB%
  - set INCLUDE=%cd%\include;%INCLUDE%
  - set OPENSSL_ROOT_DIR=%cd%
# Qtkeychain
  - if not exist c:\dev\qtkeychain (set SHOULD_DOWNLOAD_QTKEYCHAIN=1) else (set SHOULD_DOWNLOAD_QTKEYCHAIN=0)
  - if %SHOULD_DOWNLOAD_QTKEYCHAIN%==1 (md c:\dev\qtkeychain) else (echo "Using cached version of qtkeychain")
  - cd c:\dev\qtkeychain
  - if %SHOULD_DOWNLOAD_QTKEYCHAIN%==1 echo "Downloading qtkeychain"
  - if %SHOULD_DOWNLOAD_QTKEYCHAIN%==1 if %qt%==msvc2015 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/qtkeychain-0.9.1-msvc2015_x86.zip -o qtkeychain-0.9.1-msvc2015_x86.zip
  - if %qt%==msvc2015 7z x qtkeychain-0.9.1-msvc2015_x86.zip
  - if %SHOULD_DOWNLOAD_QTKEYCHAIN%==1 if %qt%==msvc2017_64 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/qtkeychain-0.9.1-msvc2017_x64.zip -o qtkeychain-0.9.1-msvc2017_x64.zip
  - if %qt%==msvc2017_64 7z x qtkeychain-0.9.1-msvc2017_x64.zip
  - if %SHOULD_DOWNLOAD_QTKEYCHAIN%==1 if %qt%==mingw492_32 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/qtkeychain-0.9.1-mingw530_x86.zip -o qtkeychain-0.9.1-mingw530_x86.zip
  - if %qt%==mingw492_32 7z x qtkeychain-0.9.1-mingw530_x86.zip
  - set PATH=%cd%\bin;%PATH%
  - set LIB=%cd%\lib;%LIB%
  - set INCLUDE=%cd%\include;%INCLUDE%
# Google breakpad
  - if %qt%==mingw492_32 set SHOULD_DOWNLOAD_BREAKPAD=0
  - if not %qt%==mingw492_32 if not exist c:\dev\breakpad (set SHOULD_DOWNLOAD_BREAKPAD=1) else (set SHOULD_DOWNLOAD_BREAKPAD=0)
  - if %SHOULD_DOWNLOAD_BREAKPAD%==1 md c:\dev\breakpad
  - if %SHOULD_DOWNLOAD_BREAKPAD%==0 if not %qt%==mingw492_32 echo "Using cached version of Google breakpad")
  - if not %qt%==mingw492_32 cd c:\dev\breakpad
  - if not %qt%==mingw492_32 (if %SHOULD_DOWNLOAD_BREAKPAD%==1 echo "Downloading breakpad")
  - if %SHOULD_DOWNLOAD_BREAKPAD%==1 (if %qt%==msvc2015 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/breakpad-msvc2015_x86.zip -o breakpad-msvc2015_x86.zip)
  - if %qt%==msvc2015 7z x breakpad-msvc2015_x86.zip
  - if %SHOULD_DOWNLOAD_BREAKPAD%==1 (if %qt%==msvc2017_64 curl -fsSL https://github.com/d1vanov/quentier-dependencies-windows/releases/download/continuous/breakpad-msvc2017_x64.zip -o breakpad-msvc2017_x64.zip)
  - if %qt%==msvc2017_64 7z x breakpad-msvc2017_x64.zip
  - if not %qt%==mingw492_32 set PATH=%cd%\bin;%PATH%
  - if not %qt%==mingw492_32 set LIB=%cd%\lib;%LIB%
  - if not %qt%==mingw492_32 set INCLUDE=%cd%\include;%INCLUDE%
# QEverCloud
  - if not exist c:\dev\qevercloud (set SHOULD_DOWNLOAD_QEVERCLOUD=1) else (set SHOULD_DOWNLOAD_QEVERCLOUD=0)
  - if %SHOULD_DOWNLOAD_QEVERCLOUD%==1 (md c:\dev\qevercloud) else (echo "Using cached version of QEverCloud")
  - cd c:\dev\qevercloud
  - if %SHOULD_DOWNLOAD_QEVERCLOUD%==1 echo "Downloading QEverCloud"
# First try to download the prebuilt binary to save the precious time as well as CPU cycles
  - md build\%APPVEYOR_REPO_BRANCH%\installdir
  - cd build\%APPVEYOR_REPO_BRANCH%\installdir
  - if %SHOULD_DOWNLOAD_QEVERCLOUD%==1 (set QEVERCLOUD_RECEIVED=0) else (set QEVERCLOUD_RECEIVED=1)
  - if %SHOULD_DOWNLOAD_QEVERCLOUD%==1 if %qt%==msvc2015 if "%APPVEYOR_REPO_BRANCH%" == "development" curl -fsSL https://github.com/d1vanov/QEverCloud/releases/download/continuous-development/qevercloud-windows-qt510-VS2015_x86.zip -o qevercloud-windows-qt510-VS2015_x86.zip & set errorlevel=0
  - if %SHOULD_DOWNLOAD_QEVERCLOUD%==1 if %qt%==msvc2015 if not "%APPVEYOR_REPO_BRANCH%" == "development" curl -fsSL https://github.com/d1vanov/QEverCloud/releases/download/continuous-master/qevercloud-windows-qt510-VS2015_x86.zip -o qevercloud-windows-qt510-VS2015_x86.zip & set errorlevel=0
  - if %SHOULD_DOWNLOAD_QEVERCLOUD%==1 if %qt%==msvc2017_64 if "%APPVEYOR_REPO_BRANCH%" == "development" curl -fsSL https://github.com/d1vanov/QEverCloud/releases/download/continuous-development/qevercloud-windows-qt510-VS2017_x64.zip -o qevercloud-windows-qt510-VS2017_x64.zip & set errorlevel=0
  - if %SHOULD_DOWNLOAD_QEVERCLOUD%==1 if %qt%==msvc2017_64 if not "%APPVEYOR_REPO_BRANCH%" == "development" curl -fsSL https://github.com/d1vanov/QEverCloud/releases/download/continuous-master/qevercloud-windows-qt510-VS2017_x64.zip -o qevercloud-windows-qt510-VS2017_x64.zip & set errorlevel=0
  - if %SHOULD_DOWNLOAD_QEVERCLOUD%==1 if %qt%==mingw492_32 if "%APPVEYOR_REPO_BRANCH%" == "development" curl -fsSL https://github.com/d1vanov/QEverCloud/releases/download/continuous-development/qevercloud-windows-qt55-MinGW_x86.zip -o qevercloud-windows-qt55-MinGW_x86.zip & set errorlevel=0
  - if %SHOULD_DOWNLOAD_QEVERCLOUD%==1 if %qt%==mingw492_32 if not "%APPVEYOR_REPO_BRANCH%" == "development" curl -fsSL https://github.com/d1vanov/QEverCloud/releases/download/continuous-master/qevercloud-windows-qt55-MinGW_x86.zip -o qevercloud-windows-qt55-MinGW_x86.zip & set errorlevel=0
  - if %qt%==msvc2015 if exist qevercloud-windows-qt510-VS2015_x86.zip set QEVERCLOUD_RECEIVED=1
  - if %qt%==msvc2017_64 if exist qevercloud-windows-qt510-VS2017_x64.zip set QEVERCLOUD_RECEIVED=1
  - if %qt%==mingw492_32 if exist qevercloud-windows-qt55-MinGW_x86.zip set QEVERCLOUD_RECEIVED=1
  - if %qt%==msvc2015 if %QEVERCLOUD_RECEIVED%==1 7z x qevercloud-windows-qt510-VS2015_x86.zip
  - if %qt%==msvc2017_64 if %QEVERCLOUD_RECEIVED%==1 7z x qevercloud-windows-qt510-VS2017_x64.zip
  - if %qt%==mingw492_32 if %QEVERCLOUD_RECEIVED%==1 7z x qevercloud-windows-qt55-MinGW_x86.zip
  - if %QEVERCLOUD_RECEIVED%==1 set PATH=%cd%\bin;%PATH%
  - if %QEVERCLOUD_RECEIVED%==1 set LIB=%cd%\lib;%LIB%
  - if %QEVERCLOUD_RECEIVED%==1 set INCLUDE=%cd%\lib;%INCLUDE%
# In case of failure clone QEverCloud repo and build the library from sources
  - if not %QEVERCLOUD_RECEIVED%==1 cd c:\dev
  - if not %QEVERCLOUD_RECEIVED%==1 rd /s /q qevercloud
  - if not %QEVERCLOUD_RECEIVED%==1 git clone https://github.com/d1vanov/QEverCloud.git qevercloud
  - if not %QEVERCLOUD_RECEIVED%==1 cd c:\dev\qevercloud
  - if not %QEVERCLOUD_RECEIVED%==1 echo "Building QEverCloud"
  - if not %QEVERCLOUD_RECEIVED%==1 if "%APPVEYOR_REPO_BRANCH%" == "development" git checkout development
  - if not %QEVERCLOUD_RECEIVED%==1 md build
  - if not %QEVERCLOUD_RECEIVED%==1 cd build
  - if not %QEVERCLOUD_RECEIVED%==1 if %qt%==mingw492_32 set PATH=%PATH:C:\Program Files\Git\usr\bin;=%
  - if not %QEVERCLOUD_RECEIVED%==1 if %qt%==mingw492_32 set PATH=C:\MinGW\bin;C:\Qt\5.5\%qt%\bin;%PATH%
  - if not %QEVERCLOUD_RECEIVED%==1 if not %qt%==mingw492_32 cmake .. -G %makefiles% -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX="c:\dev\qevercloud\build\%APPVEYOR_REPO_BRANCH%\installdir" -DCMAKE_PREFIX_PATH="C:/Qt/5.10/%qt%
  - if not %QEVERCLOUD_RECEIVED%==1 if %qt%==mingw492_32 cmake .. -G %makefiles% -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX="c:\dev\qevercloud\build\%APPVEYOR_REPO_BRANCH%\installdir" -DUSE_QT5_WEBKIT=1 -DCMAKE_PREFIX_PATH="C:/Qt/5.5/%qt%
  - if not %QEVERCLOUD_RECEIVED%==1 cmake --build . --target all
  - if not %QEVERCLOUD_RECEIVED%==1 cmake --build . --target check
  - if not %QEVERCLOUD_RECEIVED%==1 cmake --build . --target install
  - if not %QEVERCLOUD_RECEIVED%==1 if %qt%==mingw492_32 set PATH=%PATH%;C:\Program Files\Git\usr\bin
  - if not %QEVERCLOUD_RECEIVED%==1 set PATH=%PATH%;%cd%\%APPVEYOR_REPO_BRANCH%\installdir\bin
  - if not %QEVERCLOUD_RECEIVED%==1 set LIB=%LIB%;%cd%\%APPVEYOR_REPO_BRANCH%\installdir\lib
  - if not %QEVERCLOUD_RECEIVED%==1 set INCLUDE=%INCLUDE%;%cd%\%APPVEYOR_REPO_BRANCH%\installdir\include
  - cd c:\dev
# Libquentier
  - if not exist c:\dev\libquentier (set SHOULD_DOWNLOAD_LIBQUENTIER=1) else (set SHOULD_DOWNLOAD_LIBQUENTIER=0)
  - if %SHOULD_DOWNLOAD_LIBQUENTIER%==1 (md c:\dev\libquentier) else (echo "Using cached version of libquentier")
  - cd c:\dev\libquentier
  - if %SHOULD_DOWNLOAD_LIBQUENTIER%==1 echo "Downloading libquentier"
# First try to download the prebuilt binary to save the precious time as well as CPU cycles
  - echo %APPVEYOR_REPO_BRANCH%
  - md build\%APPVEYOR_REPO_BRANCH%\installdir
  - cd build\%APPVEYOR_REPO_BRANCH%\installdir
  - if %SHOULD_DOWNLOAD_LIBQUENTIER%==1 (set LIBQUENTIER_RECEIVED=0) else (set LIBQUENTIER_RECEIVED=1)
  - if %SHOULD_DOWNLOAD_LIBQUENTIER%==1 if %qt%==msvc2015 if "%APPVEYOR_REPO_BRANCH%" == "development" curl -fsSL https://github.com/d1vanov/libquentier/releases/download/continuous-development/libquentier-windows-qt510-VS2015_x86.zip -o libquentier-windows-qt510-VS2015_x86.zip & set errorlevel=0
  - if %SHOULD_DOWNLOAD_LIBQUENTIER%==1 if %qt%==msvc2015 if not "%APPVEYOR_REPO_BRANCH%" == "development" curl -fsSL https://github.com/d1vanov/libquentier/releases/download/continuous-master/libquentier-windows-qt510-VS2015_x86.zip -o libquentier-windows-qt510-VS2015_x86.zip & set errorlevel=0
  - if %SHOULD_DOWNLOAD_LIBQUENTIER%==1 if %qt%==msvc2017_64 if "%APPVEYOR_REPO_BRANCH%" == "development" curl -fsSL https://github.com/d1vanov/libquentier/releases/download/continuous-development/libquentier-windows-qt510-VS2017_x64.zip -o libquentier-windows-qt510-VS2017_x64.zip & set errorlevel=0
  - if %SHOULD_DOWNLOAD_LIBQUENTIER%==1 if %qt%==msvc2017_64 if not "%APPVEYOR_REPO_BRANCH%" == "development" curl -fsSL https://github.com/d1vanov/libquentier/releases/download/continuous-master/libquentier-windows-qt510-VS2017_x64.zip -o libquentier-windows-qt510-VS2017_x64.zip & set errorlevel=0
  - if %SHOULD_DOWNLOAD_LIBQUENTIER%==1 if %qt%==mingw492_32 if "%APPVEYOR_REPO_BRANCH%" == "development" curl -fsSL https://github.com/d1vanov/libquentier/releases/download/continuous-development/libquentier-windows-qt55-MinGW_x86.zip -o libquentier-windows-qt55-MinGW_x86.zip & set errorlevel=0
  - if %SHOULD_DOWNLOAD_LIBQUENTIER%==1 if %qt%==mingw492_32 if not "%APPVEYOR_REPO_BRANCH%" == "development" curl -fsSL https://github.com/d1vanov/libquentier/releases/download/continuous-master/libquentier-windows-qt55-MinGW_x86.zip -o libquentier-windows-qt55-MinGW_x86.zip & set errorlevel=0
  - if %qt%==msvc2015 if exist libquentier-windows-qt510-VS2015_x86.zip set LIBQUENTIER_RECEIVED=1
  - if %qt%==msvc2017_64 if exist libquentier-windows-qt510-VS2017_x64.zip set LIBQUENTIER_RECEIVED=1
  - if %qt%==mingw492_32 if exist libquentier-windows-qt55-MinGW_x86.zip set LIBQUENTIER_RECEIVED=1
  - if %qt%==msvc2015 if %LIBQUENTIER_RECEIVED%==1 7z x libquentier-windows-qt510-VS2015_x86.zip
  - if %qt%==msvc2017_64 if %LIBQUENTIER_RECEIVED%==1 7z x libquentier-windows-qt510-VS2017_x64.zip
  - if %qt%==mingw492_32 if %LIBQUENTIER_RECEIVED%==1 7z x libquentier-windows-qt55-MinGW_x86.zip
  - if %LIBQUENTIER_RECEIVED%==1 set PATH=%cd%\bin;%PATH%
  - if %LIBQUENTIER_RECEIVED%==1 set LIB=%cd%\lib;%LIB%
  - if %LIBQUENTIER_RECEIVED%==1 set INCLUDE=%cd%\include;%INCLUDE%
# In case of failure clone the libquentier repo and build the library from sources
  - if not %LIBQUENTIER_RECEIVED%==1 cd c:\dev
  - if not %LIBQUENTIER_RECEIVED%==1 rd /s /q libquentier
  - if not %LIBQUENTIER_RECEIVED%==1 git clone https://github.com/d1vanov/libquentier.git libquentier
  - if not %LIBQUENTIER_RECEIVED%==1 cd libquentier
  - if not %LIBQUENTIER_RECEIVED%==1 echo "Building libquentier"
  - if not %LIBQUENTIER_RECEIVED%==1 if %APPVEYOR_REPO_BRANCH%=="development" git checkout development
  - if not %LIBQUENTIER_RECEIVED%==1 md build
  - if not %LIBQUENTIER_RECEIVED%==1 cd build
  - if not %LIBQUENTIER_RECEIVED%==1 if %qt%==mingw492_32 set PATH=%PATH:C:\Program Files\Git\usr\bin;=%
  - if not %LIBQUENTIER_RECEIVED%==1 if %qt%==mingw492_32 set PATH=C:\MinGW\bin;C:\Qt\5.5\%qt%\bin;%PATH%
  - if not %LIBQUENTIER_RECEIVED%==1 if not %qt%==mingw492_32 cmake .. -G %makefiles% -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX="c:\dev\libquentier\build\%APPVEYOR_REPO_BRANCH%\installdir" -DCMAKE_PREFIX_PATH="C:/Qt/5.10/%qt%"
  - if not %LIBQUENTIER_RECEIVED%==1 if %qt%==mingw492_32 cmake .. -G %makefiles% -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX="c:\dev\libquentier\build\%APPVEYOR_REPO_BRANCH%\installdir" -DUSE_QT5_WEBKIT=1 -DCMAKE_PREFIX_PATH="C:/Qt/5.5/%qt%
  - if not %LIBQUENTIER_RECEIVED%==1 cmake --build . --target all
  - if not %LIBQUENTIER_RECEIVED%==1 if NOT ERRORLEVEL 0 exit 1
  - if not %LIBQUENTIER_RECEIVED%==1 cmake --build . --target check
  - if not %LIBQUENTIER_RECEIVED%==1 if NOT ERRORLEVEL 0 exit 1
  - if not %LIBQUENTIER_RECEIVED%==1 cmake --build . --target lupdate
  - if not %LIBQUENTIER_RECEIVED%==1 if NOT ERRORLEVEL 0 exit 1
  - if not %LIBQUENTIER_RECEIVED%==1 cmake --build . --target lrelease
  - if not %LIBQUENTIER_RECEIVED%==1 if NOT ERRORLEVEL 0 exit 1
  - if not %LIBQUENTIER_RECEIVED%==1 cmake --build . --target install
  - if not %LIBQUENTIER_RECEIVED%==1 if NOT ERRORLEVEL 0 exit 1
  - if not %LIBQUENTIER_RECEIVED%==1 if %qt%==mingw492_32 set PATH=%PATH%;C:\Program Files\Git\usr\bin
  - if not %LIBQUENTIER_RECEIVED%==1 set PATH=%PATH%;%cd%\%APPVEYOR_REPO_BRANCH%\installdir\bin
  - if not %LIBQUENTIER_RECEIVED%==1 set LIB=%LIB%;%cd%\%APPVEYOR_REPO_BRANCH%\installdir\lib
  - if not %LIBQUENTIER_RECEIVED%==1 set INCLUDE=%INCLUDE%;%cd%\%APPVEYOR_REPO_BRANCH%\installdir\include

before_build:
  - cd c:\dev\quentier
  - mkdir build\bin\quentier
  - if not %qt%==mingw492_32 copy c:\dev\breakpad\bin\common.pdb c:\dev\quentier\build\bin\quentier\common.pdb
  - if not %qt%==mingw492_32 copy c:\dev\breakpad\bin\crash_generation_client.pdb c:\dev\quentier\build\bin\quentier\crash_generation_client.pdb
  - if not %qt%==mingw492_32 copy c:\dev\breakpad\bin\exception_handler.pdb c:\dev\quentier\build\bin\quentier\exception_handler.pdb

build_script:
  - cd c:\dev\quentier\build
  - if %qt%==mingw492_32 set PATH=%PATH:C:\Program Files\Git\usr\bin;=%
  - if %qt%==mingw492_32 set PATH=C:\MinGW\bin;C:\Qt\5.5\%qt%\bin;%PATH%
  - if %qt%==mingw492_32 cmake .. -G %makefiles% -DCMAKE_VERBOSE_MAKEFILE=ON -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX="c:/dev/install" -DBUILD_WITH_WIKI_TOOLS=1 -DCMAKE_PREFIX_PATH="C:/Qt/5.5/%qt%" -DZLIB_LIBRARY="C:/dev/zlib/lib/libz.dll.a" -DNSIS_MAKE="c:/Program Files (x86)/NSIS/makensis.exe" -DOPENSSL_ROOT_DIR="c:/dev/openssl" -DBOOST_ROOT="c:/dev/boost"
  - if not %qt%==mingw492_32 cmake .. -G %makefiles% -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX="c:/dev/install" -DBUILD_WITH_WIKI_TOOLS=1 -DCMAKE_PREFIX_PATH="C:/Qt/5.10/%qt%" -DZLIB_LIBRARY="C:/dev/zlib/lib/libz.lib" -DBREAKPAD_ROOT="C:/dev/breakpad" -DNSIS_MAKE="c:/Program Files (x86)/NSIS/makensis.exe" -DOPENSSL_ROOT_DIR="c:/dev/openssl" -DBOOST_ROOT="c:/dev/boost"
  - cmake --build . --target all
  - if NOT ERRORLEVEL 0 exit 1
  - cmake --build . --target check
  - if NOT ERRORLEVEL 0 exit 1
  - cmake --build . --target lupdate
  - if NOT ERRORLEVEL 0 exit 1
  - cmake --build . --target lrelease
  - if NOT ERRORLEVEL 0 exit 1
  - cmake --build . --target install
  - if NOT ERRORLEVEL 0 exit 1
  - move bin\quentier\Setup*.exe %APPVEYOR_BUILD_FOLDER%
  - if %qt%==mingw492_32 set PATH=%ORIGPATH%

after_build:
  - cd c:\dev\install
  - 7z a -tzip -mx=9 -mfb=128 -mpass=10 %DEPLOYMENT_TARGET% c:\dev\install\*
  - move %DEPLOYMENT_TARGET% %APPVEYOR_BUILD_FOLDER%
  - cd %APPVEYOR_BUILD_FOLDER%
  - c:\dev\ciuploadtool\ciuploadtool.exe -suffix="%APPVEYOR_REPO_BRANCH%" Setup*.exe Quentier-*.zip

artifacts:
  - path: '*.zip'
    name: archive
  - path: 'Setup*.exe'
    name: installer

matrix:
  allow_failures:
    - prepare_mode: YES
  fast_finish: true

cache:
  - 'c:\dev\ciuploadtool\ciuploadtool.exe -> ci\appveyor\cache_versions\ciuploadtool.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\libiconv\libiconv-1.15-msvc2015_x86.zip -> ci\appveyor\cache_versions\libiconv-msvc2015_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\libiconv\libiconv-1.15-msvc2017_x64.zip -> ci\appveyor\cache_versions\libiconv-msvc2017_x64.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\libiconv\libiconv-1.15-mingw530_x86.zip -> ci\appveyor\cache_versions\libiconv-mingw530_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\zlib\zlib-1.2.11-msvc2015_x86.zip -> ci\appveyor\cache_versions\zlib-msvc2015_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\zlib\zlib-1.2.11-msvc2017_x64.zip -> ci\appveyor\cache_versions\zlib-msvc2017_x64.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\zlib\zlib-1.2.11-mingw530_x86.zip -> ci\appveyor\cache_versions\zlib-mingw530_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\libxml2\libxml2-2.9.7-msvc2015_x86.zip -> ci\appveyor\cache_versions\libxml2-msvc2015_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\libxml2\libxml2-2.9.7-msvc2017_x64.zip -> ci\appveyor\cache_versions\libxml2-msvc2017_x64.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\libxml2\libxml2-2.9.7-mingw530_x86.zip -> ci\appveyor\cache_versions\libxml2-mingw530_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\libhunspell\libhunspell-1.7.0-msvc2015_x86.zip -> ci\appveyor\cache_versions\libhunspell-msvc2015_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\libhunspell\libhunspell-1.7.0-msvc2017_x64.zip -> ci\appveyor\cache_versions\libhunspell-msvc2017_x64.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\libhunspell\libhunspell-1.6.2-mingw_x86.zip -> ci\appveyor\cache_versions\libhunspell-mingw530_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\tidy-html5\tidy-html5-5.6.0-msvc2015_x86.zip -> ci\appveyor\cache_versions\tidy-html5-msvc2015_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\tidy-html5\tidy-html5-5.6.0-msvc2017_x64.zip -> ci\appveyor\cache_versions\tidy-html5-msvc2017_x64.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\tidy-html5\tidy-html5-5.6.0-mingw530_x86.zip -> ci\appveyor\cache_versions\tidy-html5-mingw530_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\boost\boost-1_65_0-msvc2015_x86.zip -> ci\appveyor\cache_versions\boost-msvc2015_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\boost\boost-1_65_0-msvc2017_x64.zip -> ci\appveyor\cache_versions\boost-msvc2017_x64.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\boost\boost-1_65_0-mingw530_x86.zip -> ci\appveyor\cache_versions\boost-mingw530_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\openssl\openssl-1_0_2r-msvc2015_x86.zip -> ci\appveyor\cache_versions\openssl-msvc2015_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\openssl\openssl-1_0_2r-msvc2017_x64.zip -> ci\appveyor\cache_versions\openssl-msvc2017_x64.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\openssl\openssl-1_0_2r-mingw530_x86.zip -> ci\appveyor\cache_versions\openssl-mingw530_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\qtkeychain\qtkeychain-0.9.1-msvc2015_x86.zip -> ci\appveyor\cache_versions\qtkeychain-msvc2015_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\qtkeychain\qtkeychain-0.9.1-msvc2017_x64.zip -> ci\appveyor\cache_versions\qtkeychain-msvc2017_x64.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\qtkeychain\qtkeychain-0.9.1-mingw530_x86.zip -> ci\appveyor\cache_versions\qtkeychain-mingw530_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\breakpad\breakpad-msvc2015_x86.zip -> ci\appveyor\cache_versions\breakpad-msvc2015_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\breakpad\breakpad-msvc2017_x64.zip -> ci\appveyor\cache_versions\breakpad-msvc2017_x64.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\qevercloud\build\master\installdir\qevercloud-windows-qt510-VS2015_x86.zip -> ci\appveyor\cache_versions\qevercloud-master-msvc2015_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\qevercloud\build\master\installdir\qevercloud-windows-qt510-VS2017_x64.zip -> ci\appveyor\cache_versions\qevercloud-master-msvc2017_x64.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\qevercloud\build\master\installdir\qevercloud-windows-qt55-MinGW_x86.zip -> ci\appveyor\cache_versions\qevercloud-master-mingw530_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\qevercloud\build\development\installdir\qevercloud-windows-qt510-VS2015_x86.zip -> ci\appveyor\cache_versions\qevercloud-development-msvc2015_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\qevercloud\build\development\installdir\qevercloud-windows-qt510-VS2017_x64.zip -> ci\appveyor\cache_versions\qevercloud-development-msvc2017_x64.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\qevercloud\build\development\installdir\qevercloud-windows-qt55-MinGW_x86.zip -> ci\appveyor\cache_versions\qevercloud-development-mingw530_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\libquentier\build\master\installdir\libquentier-windows-qt510-VS2015_x86.zip -> ci\appveyor\cache_versions\libquentier-master-msvc2015_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\libquentier\build\master\installdir\libquentier-windows-qt510-VS2017_x64.zip -> ci\appveyor\cache_versions\libquentier-master-msvc2017_x64.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\libquentier\build\master\installdir\libquentier-windows-qt55-MinGW_x86.zip -> ci\appveyor\cache_versions\libquentier-master-mingw530_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\libquentier\build\development\installdir\libquentier-windows-qt510-VS2015_x86.zip -> ci\appveyor\cache_versions\libquentier-development-msvc2015_x86.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\libquentier\build\development\installdir\libquentier-windows-qt510-VS2017_x64.zip -> ci\appveyor\cache_versions\libquentier-development-msvc2017_x64.txt, ci\appveyor\cache_versions\global.txt'
  - 'c:\dev\libquentier\build\development\installdir\libquentier-windows-qt55-MinGW_x86.zip -> ci\appveyor\cache_versions\libquentier-development-mingw530_x86.txt, ci\appveyor\cache_versions\global.txt'
