<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
	<meta name="generator" content="Hugo 0.40.1" />
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  

  <title> Quentier </title>

  
  <link rel="stylesheet" href="https://d1vanov.github.io/quentier/css/poole.css">
  <link rel="stylesheet" href="https://d1vanov.github.io/quentier/css/syntax.css">
  <link rel="stylesheet" href="https://d1vanov.github.io/quentier/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon" sizes="180x180" href="/quentier/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/quentier/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/quentier/favicon-16x16.png">
  <link rel="manifest" href="/quentier/manifest.json">
  <link rel="mask-icon" href="/quentier/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ffffff">

  
  <link href="https://d1vanov.github.io/quentier/index.xml" rel="alternate" type="application/rss+xml" title="Quentier" />
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300' rel='stylesheet' type='text/css'>

  <script src="//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"></script>
  <script>
    WebFont.load({
      google: {
        families: ['Fira Sans']
      }
    });
  </script>

</head>

<body class="theme-base-0d">

<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about" align=center>
      <h1 class="brand"><a href="https://d1vanov.github.io/quentier">Quentier</a></h1>
      <img src="/quentier/quentier_icon.svg" width=50% />
      <p class="lead">
         Free &amp; open source desktop Evernote client 
      </p>
    </div>
    <ul class="sidebar-nav">
      <li><a href="https://d1vanov.github.io/quentier/blog">Posts</a></li>
      <ul class="posts">
          
          <li><span><a href="https://d1vanov.github.io/quentier/blog/quentier-local-storage-overview/">Quentier local storage implementation overview</a></span></li>
          
          <li><span><a href="https://d1vanov.github.io/quentier/blog/quentier-installation-of-dependencies/">Installation of Quentier&#39;s dependencies</a></span></li>
          
          <li><span><a href="https://d1vanov.github.io/quentier/blog/quentier-technical-overview/">Quentier internals overview</a></span></li>
          
          <li><span><a href="https://d1vanov.github.io/quentier/blog/quentier-brief-overview/">Brief overview of Quentier features</a></span></li>
          
          <li><span><a href="https://d1vanov.github.io/quentier/blog/helloworld/">Hello world!</a></span></li>
          
      </ul>
      
      <br/> 
    </ul>
     
    
    
    <a href="https://github.com/d1vanov"><i class="fa fa-github-square"></i></a>&nbsp;&nbsp; 
    
    
      <a href="https://d1vanov.github.io/quentier/index.xml" type="application/rss+xml"><i class="fa fa-rss-square"></i></a>
    

    <p class="footnote">powered by <a href="http://gohugo.io">Hugo</a> <br/> &copy; 2019 Dmitry Ivanov. All rights reserved.</p>

  </div>
</div>


    <div class="content container">
<div class="posts">

      
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://d1vanov.github.io/quentier/blog/quentier-local-storage-overview/">
        Quentier local storage implementation overview
      </a>
    </h1>

    <span class="post-date">Mar 15, 2018</span>

    
      
      <p class="seriesname">Series: <a href="https://d1vanov.github.io/quentier/series/developers-guide">Developers guide</a></p>
    


    <p>This post continues the exploration of Quentier&rsquo;s internals: here we&rsquo;ll talk about the implementation details of Quentier&rsquo;s local storage.</p>

<p>As I mentioned in the <a href="/quentier/blog/quentier-technical-overview">brief technical overview</a> post, the local storage within libquentier uses SQLite as its backend i.e. all the data downloaded from Evernote (or user&rsquo;s own data in case of local account) is stored within a SQLite database. However, it is just an implementation detail: the fact of SQLite usage is completely opaque to any clients of local storage functionality within libquentier. So in theory is is possible to change the database backend in future to whatever one is considered better - even to storage of plain files within some folder. Internally SQLite is used through Qt&rsquo;s <code>QtSql</code> module.</p>

<p>Libquentier provides both synchronous and asynchronous versions of local storage management - which correspond to <code>LocalStorageManager</code> and <code>LocalStorageManagerAsync</code> classes within the public libquentier API. The asynchronous interface offers signals and slots for asynchronous communication with the local storage for clients. In Quentier local storage operations run within a separate dedicated thread of execution so the communication with the outside world via signals and slots is truly asynchronous. As such communication is asynchronous, each signal and slot involved has a special parameter of type <code>QUuid</code> which is called <code>requestId</code> in most cases. This identifier allows the clients of local storage to identify which particular signal from the local storage is the response to their query i.e. to the invokation of some <code>LocalStorageManagerAsync</code>&rsquo;s slot - the response signal would have the same request identifier as the one passed to the slot.</p>

<p><code>LocalStorageManagerAsync</code> maintains the in-memory cache of several most recently added/updated/looked up data tems following the assumption that these items would be quickly accessed again. At the time of this writing there&rsquo;s no collection of cache hit/miss statistics although it would be nice to implement it in order to see how useful that in-memory cache really is. Note that this cache is not the same as the in-memory cache of data maintained by SQLite itself - SQLite&rsquo;s in-memory cache is completely opaque to the code requesting stuff from the database; <code>LocalStorageManagerAsync</code>&rsquo;s cache is only opaque to its own clients. Libquentier&rsquo;s API makes it possible to disable <code>LocalStorageManagerAsync</code>&rsquo;s cache by calling <code>setUseCache(false)</code> on <code>LocalStorageManagerAsync</code> instance. Libquentier also allows one to customize the cache expiration function by passing an object of a custom subclass of <code>ILocalStorageCacheExpiryChecker</code> to <code>LocalStorageManagerAsync</code>&rsquo;s <code>installCacheExpiryFunction</code> method. The methods of this class evaluate when it&rsquo;s time to drop the least recently used data items from the cache.</p>

<p>More involved interface for working with the cache is accessible with the help of <code>LocalStorageCacheManager</code> class the const pointer to which can be retrieved from <code>LocalStorageManagerAsync</code> via <code>localStorageCacheManager()</code> method. The returned pointer would be nullptr if the cache was disabled.</p>

<p><code>LocalStorageManagerAsync</code> acts as a wrapper around synchronous <code>LocalStorageManager</code> class so its role is to implement the asynchronous interface around the synchronous one and also to maintain the cache of most recently used data items.</p>

<p><code>LocalStorageManager</code>&rsquo;s interface is pretty self-explanatory and also contains quite complete Doxygen documentation: it offers the ability to add/update/search/remove/list (with limit, offset and sorting order) notes/notebooks/tags/saved searches/resources (attachments to notes).</p>

<p>Now some info about the private implementation of local storage management.</p>

<p>First, if you not familiar with pimpl idiom, you can read about it <a href="https://en.wikipedia.org/wiki/Opaque_pointer">here</a>. In C++/Qt/KDE the pattern is also known as d-pointer. Pimpl idiom is the way in which private local storage management implementation is hidden from the clients using the API. Is it a pretty standard pattern for shared libraries intended to prevent the breakage of <a href="https://en.wikipedia.org/wiki/Application_binary_interface">ABI</a> due to internal implementation changes.</p>

<p>In context of local storage management public <code>LocalStorageManager</code> class has a single pointer to its opaque implementation class: <code>LocalStorageManagerPrivate</code>:</p>

<pre><code>QT_FORWARD_DECLARE_CLASS(LocalStorageManagerPrivate)

class QUENTIER_EXPORT LocalStorageManager: public QObject
{
    Q_OBJECT
public:
    &lt;...&gt;

private:
    QScopedPointer&lt;LocalStorageManagerPrivate&gt;  d_ptr;
    Q_DECLARE_PRIVATE(LocalStorageManager)
};
</code></pre>

<p>This private class is declared in <code>src/local_storage/LocalStorageManager_p.h</code> (and the implementation is within <code>.cpp</code> file with the same base name). The same approach is used for the implementation of <code>LocalStorageCacheManager</code>, it is declared in <code>src/local_storage/LocalStorageCacheManager_p.h</code>. The actual implementation of the cache is not very simple: it uses <a href="http://www.boost.org/doc/libs/release/libs/multi_index/doc/index.html">multi-index container</a> from <a href="http://www.boost.org">boost</a> library and one of indices is the last access timestamp. It might be a little overkill compared to some simplistic LRU cache based on a map and a linked list but several other indices are used as well so it won&rsquo;t be just a single key map anyway.</p>

<p>The contents of <code>LocalStorageManagerPrivate</code> class (the one declared in <code>src/local_storage/LocalStorageManager_p.h</code>) are rougly as follows:
 * public methods repeating those specified in the public interface of <code>LocalStorageManager</code> class - these are the methods to which the control is handed over by the public class&rsquo; methods
 * private methods
 * private class members</p>

<p>Let&rsquo;s start from one single private method which provides the most important information about how the local storage database is organized: <code>createTables</code>. This method is called every time the account is switched as well as when the local storage manager is created for some particular account. However, this method only really does real work just once, when the account is created for the first time because in this case the tables within SQLite database are actually being created. All the next times their creation is simply skipped. Here&rsquo;s a simple example of what happens within <code>createTables</code> method:</p>

<pre><code>res = query.exec(QStringLiteral(&quot;CREATE TABLE IF NOT EXISTS Users(&quot;
                                &quot;  id                              INTEGER PRIMARY KEY     NOT NULL UNIQUE, &quot;
                                &quot;  username                        TEXT                    DEFAULT NULL, &quot;
                                &quot;  email                           TEXT                    DEFAULT NULL, &quot;
                                &quot;  name                            TEXT                    DEFAULT NULL, &quot;
                                &lt;... more rows here ...&gt;
                                &quot;)&quot;));
errorPrefix.setBase(QT_TR_NOOP(&quot;Can't create Users table&quot;));
DATABASE_CHECK_AND_SET_ERROR();
</code></pre>

<p>Each table has some column serving as the primary key. For most tables such column is called <code>localUid</code>. It is the complement for Evernote&rsquo;s <code>guid</code> - globally unique identifier. Guids are assigned to data items by Evernote servers, not by the client apps. So if Quentier was to rely on guids as primary keys, it would have to contant Evernote servers each time a new note or notebook or tag or saved search or note attachment is created. Doing so would effectively kill the ability to work with the notes within Evernote account offline. So the local storage uses the unique key of its own - <code>localUid</code> or <code>local unique identifier</code>. This key is not sent to Evernote during the synchronization so only libquentier&rsquo;s client apps know about its existence. Local uid is primarily used to support data items both already synchronized with Evernote and not yet synchronized. In local accounts data items are not synchronized with Evernote at all so they would need some kind of unique identifier anyway.</p>

<p>Some tables have columns referencing other tables&rsquo; columns - those are subjects to <a href="https://sqlite.org/foreignkeys.html">foreign key constraints</a> meant to help maintain the integrity of the database and reject attempts to do something which, if performed, would leave the database in some inconsistent state. One example of such a constraint is as follows:</p>

<pre><code>res = query.exec(QStringLiteral(&quot;CREATE TABLE IF NOT EXISTS Notes(&quot;
                                &quot;  localUid                        TEXT PRIMARY KEY     NOT NULL UNIQUE, &quot;
                                &quot;  guid                            TEXT                 DEFAULT NULL UNIQUE, &quot;
                                &quot;  updateSequenceNumber            INTEGER              DEFAULT NULL, &quot;
                                &lt;... more rows here ...&gt;
                                &quot;  notebookLocalUid REFERENCES Notebooks(localUid) ON UPDATE CASCADE, &quot;
                                &quot;  notebookGuid REFERENCES Notebooks(guid) ON UPDATE CASCADE, &quot;
                                &lt;... more rows here ...&gt;
                                &quot;  UNIQUE(localUid, guid)&quot;
                                &quot;)&quot;));
errorPrefix.setBase(QT_TR_NOOP(&quot;Can't create Notes table&quot;));
DATABASE_CHECK_AND_SET_ERROR();
</code></pre>

<p>The foreign key constraints for notes mean that they should only contain notebook local uid and/or guid which are present within the notebooks table. Otherwise it won&rsquo;t make sense - note says it is from a notebook which doesn&rsquo;t exist! The database which allowed that to happen would have to be considered corrupted. Possibly it could be repaired by manually creating such a notebook but it&rsquo;s not something the user of the app would be happy to do so it&rsquo;s better to prevent the possibility of such corruption altogether.</p>

<p>Notice that the specification on notebook local uid and guid columns is <code>ON UPDATE CASCADE</code> and not <code>ON UPDATE CASCADE ON DELETE CASCADE</code>. The latter one would mean that the removal of a notebook should lead to the removal of all its notes but unfortunately this <code>ON DELETE CASCADE</code> interferes with specific kind of updates within notebooks table - the updates of <code>INSERT OR REPLACE</code> form. Apparently SQLite thinks that <code>REPLACE</code> corresponds to <code>DELETE</code> followed by <code>INSERT</code>. So on the update of a notebook it would delete the notebook and all the notes inside it and then insert the notebook back. But not the deleted notes.</p>

<p>In order to prevent that, another way to maintain the consistency on notebook removal has been implemented:</p>

<pre><code>res = query.exec(QStringLiteral(&quot;CREATE TRIGGER IF NOT EXISTS on_notebook_delete_trigger BEFORE DELETE ON Notebooks &quot;
                                &quot;BEGIN &quot;
                                &quot;DELETE FROM NotebookRestrictions WHERE NotebookRestrictions.localUid=OLD.localUid; &quot;
                                &quot;DELETE FROM SharedNotebooks WHERE SharedNotebooks.sharedNotebookNotebookGuid=OLD.guid; &quot;
                                &quot;DELETE FROM Notes WHERE Notes.notebookLocalUid=OLD.localUid; &quot;
                                &quot;END&quot;));
errorPrefix.setBase(QT_TR_NOOP(&quot;Can't create trigger to fire on notebook deletion&quot;));
DATABASE_CHECK_AND_SET_ERROR();
</code></pre>

<p>This trigger would be executed before the <strong>actual</strong> permanent removal of a notebook and would ensure the related tables stay consistent by removing those of their rows which reference the about to be deleted notebook.</p>

<p>In addition to &ldquo;usual&rdquo; tables there are also some <a href="https://sqlite.org/vtab.html">virtual tables</a> for efficient searching of stuff within the database. For example:</p>

<pre><code>res = query.exec(QStringLiteral(&quot;CREATE VIRTUAL TABLE IF NOT EXISTS NotebookFTS USING FTS4(content=\&quot;Notebooks\&quot;, &quot;
                                &quot;localUid, guid, notebookName)&quot;));
errorPrefix.setBase(QT_TR_NOOP(&quot;Can't create virtual FTS4 NotebookFTS table&quot;));
DATABASE_CHECK_AND_SET_ERROR();
</code></pre>

<p><a href="https://sqlite.org/fts3.html">FTS4</a> is one of SQLite&rsquo;s implementations of full text search. Although it&rsquo;s not of much importance in 2018, some Linux distros used to ship Qt4 versions with SQLite containing only FTS3 implementations - such versions of Qt4 won&rsquo;t be suitable for libquentier - it would compile but tests won&rsquo;t pass and in general things won&rsquo;t work. So if you are building libquentier with Qt4, it is strongly recommended to run libquentier&rsquo;s tests to ensure they pass and hence Qt&rsquo;s SQLite supports FTS4.</p>

<p>Other private methods of <code>LocalStorageManagerPrivate</code> class serve as implementation pieces of public methods. These private methods can be roughly categorized as follows:
 * methods running <code>INSERT OR REPLACE</code> queries which are used by methods adding items to the local storage as well as by methods updating items within the local storage
 * methods running <code>SELECT</code> queries which are used by methods listing or searching items within the local storage
 * methods preparing <code>INSERT OR REPLACE</code> queries - more on this in a moment
 * other auxiliary methods</p>

<p><a href="https://sqlite.org/c3ref/stmt.html">Preparing</a> a SQL query roughly means converting it from a human readable string into SQLite byte code. For certain types of queries it is easy to do the preparation step once and then run the prepared query over and over again which results in removing the duplicate work each time the query needs to run. For this reason <code>INSERT OR REPLACE</code> queries are prepared once and then run several times until the account is switched or until <code>LocalStorageManagerPrivate</code> class is destroyed (when Quentier is shut down, for example). The data members of <code>LocalStorageManagerPrivate</code> class corresponding to these queries look like this:</p>

<pre><code>QSqlQuery           m_insertOrReplaceSavedSearchQuery;
bool                m_insertOrReplaceSavedSearchQueryPrepared;
</code></pre>

<p>The bool serves for checking whether the query has already been prepared or not.</p>

<p>That wraps up the introduction to the local storage management internals of Quentier. Due to the fact the code performing this management lives within libquentier library, other applications can also make use of this code which, together with libquentier&rsquo;s synchronization abilities, can enable other apps to easily perform full and incremental sync of Evernote account data to the local database.</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://d1vanov.github.io/quentier/blog/quentier-installation-of-dependencies/">
        Installation of Quentier&#39;s dependencies
      </a>
    </h1>

    <span class="post-date">Jan 19, 2018</span>

    
      
      <p class="seriesname">Series: <a href="https://d1vanov.github.io/quentier/series/developers-guide">Developers guide</a></p>
    


    

<p><strong>Updated 2019-05-03</strong></p>

<h3 id="table-of-contents">Table of contents</h3>

<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#dependencies">Dependencies</a></li>
<li><a href="#linux">Linux</a></li>
<li><a href="#mac">Mac</a></li>
<li><a href="#windows">Windows</a>

<ul>
<li><a href="#building-dependencies-with-visual-studio">Building dependencies with Visual Studio</a>

<ul>
<li><a href="#preparing-the-environment">Preparing the environment</a></li>
<li><a href="#building-boost-program-options-library">Building boost program options library</a></li>
<li><a href="#building-openssl">Building OpenSSL</a></li>
<li><a href="#building-libiconv">Building libiconv</a></li>
<li><a href="#building-zlib">Building zlib</a></li>
<li><a href="#building-libxml2">Building libxml2</a></li>
<li><a href="#building-libhunspell">Building libhunspell</a></li>
<li><a href="#building-tidy-html5">Building tidy-html5</a></li>
<li><a href="#building-qtkeychain">Building qtkeychain</a></li>
<li><a href="#building-google-breakpad">Building Google breakpad</a></li>
</ul></li>
<li><a href="#building-dependencies-with-mingw">Building dependencies with MinGW</a>

<ul>
<li><a href="#building-boost-program-options-library-1">Building boost program options library</a></li>
<li><a href="#building-openssl-1">Building OpenSSL</a></li>
<li><a href="#building-libiconv-1">Building libiconv</a></li>
<li><a href="#building-zlib-1">Building zlib</a></li>
<li><a href="#building-libxml2-1">Building libxml2</a></li>
<li><a href="#building-libhunspell-1">Building libhunspell</a></li>
<li><a href="#building-tidy-html5-1">Building tidy-html5</a></li>
<li><a href="#building-qtkeychain-1">Building qtkeychain</a></li>
</ul></li>
</ul></li>
</ul>

<h3 id="introduction">Introduction</h3>

<p>Quentier has a fair share of dependencies and their installation is a complex enough procedure, especially on Windows platform. This post explains some details of the process.</p>

<h3 id="dependencies">Dependencies</h3>

<p>First let&rsquo;s just enumerate the dependencies:</p>

<p>Quentier itself depends on just a few Qt modules:</p>

<ul>
<li>For Qt4: QtCore, QtGui</li>
<li>For Qt5: Qt5Core, Qt5Gui, Qt5Widgets, Qt5LinguistTools</li>
</ul>

<p>Quentier also depends on the following libraries:</p>

<ul>
<li><a href="http://github.com/d1vanov/libquentier">libquentier</a></li>
<li><a href="https://github.com/d1vanov/QEverCloud">QEverCloud</a></li>
<li><a href="http://www.boost.org/doc/libs/release/libs/program_options">Boost program options</a> (&gt;= 1.38)</li>
<li>For Qt4 buidls only: <a href="https://github.com/d1vanov/qt4-mimetypes">qt4-mimetypes</a></li>
<li>Optional although recommended dependency on Linux and Windows (with MSVC only at the time): <a href="https://chromium.googlesource.com/breakpad/breakpad">Google breakpad</a></li>
</ul>

<p>Although it is theoretically possible to use different Qt versions to build Quentier and its dependencies, it is highly not recommended as it can cause all sort of building and/or runtime issues.</p>

<p>Libquentier&rsquo;s dependencies are as follows:</p>

<ul>
<li>For Qt4: QtCore, QtGui, QtNetwork, QtXml, QtSql, QtTest + QtDBus on Linux platform only + optionally (although required for using libquentier along with Quentier app) QtWebKit</li>
<li>For Qt5: Qt5Core, Qt5Gui, Qt5Widgets, Qt5Network, Qt5PrintSupport, Qt5Xml, Qt5Sql, Qt5Test, Qt5LinguistTools + Qt5DBus on Linux platform only + optionally (although required for using libquentier along with Quentier app) either Qt5WebKit and Qt5WebKitWidgets or Qt5WebEngine (and Qt5WebEngineCore for Qt &gt;= 5.6), Qt5WebEngineWidgets, Qt5WebSockets and Qt5WebChannel</li>
<li><a href="http://www.xmlsoft.org">libxml2</a> - for validation of Evernote&rsquo;s ENML note formatting against the DTD</li>
<li><a href="https://www.openssl.org">OpenSSL</a> - for encryption and decryption of note fragments as well as for Qt&rsquo;s usage of secure networking. Note that ssl/crypto libraries built into OS X / macOS by Apple don&rsquo;t contain the required encryption/decryption API and are therefore not suitable for building libquentier - you would encounter build errors if you try to use those built-in libraries. OpenSSL from <a href="https://brew.sh">Homebrew</a> or <a href="https://www.macports.org">Macports</a> would be suitable</li>
<li><a href="http://www.boost.org">Boost</a> - some header-only libraries are used, mostly <a href="http://www.boost.org/doc/libs/1_66_0/libs/multi_index/doc/index.html">multi index container</a> and <a href="http://www.boost.org/doc/libs/1_66_0/libs/bimap/doc/html/index.html">bimap</a></li>
<li><a href="https://hunspell.github.io">libhunspell</a> - for spell checking within the note editor</li>
<li><a href="https://github.com/frankosterfeld/qtkeychain">QtKeychain</a> - for reliable storage of various Evernote service&rsquo;s tokens which shouldn&rsquo;t be stored in clear text</li>
<li><a href="https://github.com/d1vanov/QEverCloud">QEverCloud</a> - for low level communication with Evernote service</li>
<li>libtidy5 from <a href="https://github.com/htacg/tidy-html5">tidy-html5</a> - for assistance in the conversion between HTML and ENML representations of notes. Note that the old libtidy 0.99 still shipped with many Linux distros won&rsquo;t be suitable!</li>
<li>For Qt4 builds only: <a href="https://github.com/d1vanov/qt4-mimetypes">qt4-mimetypes</a> - backport of Qt5&rsquo;s mime types handling to Qt4</li>
<li>Optionally: <a href="https://www.stack.nl/~dimitri/doxygen">Doxygen</a> (for automatic generation of documentation)</li>
</ul>

<p>In addition to this, libxml2 might depend on <a href="https://www.gnu.org/software/libiconv">libiconv</a> and <a href="https://zlib.net">zlib</a>.</p>

<p>On Linux and Mac at least several of these dependencies can be installed via package managers. On Windows there are several package managers as well, however, they weren&rsquo;t evaluated for being useful for installing Quentier&rsquo;s dependencies. Instead, some Quentier&rsquo;s dependencies for Windows can be downloaded from the Internet and others can be built and installed manually. Some of Quentier&rsquo;s dependencies require a couple of minor patches to support proper building on Windows.</p>

<p>Instead of (or in addition to) reading this tutorial you can look at Quentier&rsquo;s <a href="https://github.com/d1vanov/quentier/blob/master/.travis.yml">Travis CI</a> configuration file which installs and builds the necessary dependencies on each Linux and Mac CI build and at <a href="https://github.com/d1vanov/quentier-dependencies-windows/blob/master/appveyor.yml">AppVeyor</a> configuration of a <a href="https://github.com/d1vanov/quentier-dependencies-windows">separate repository</a> set up for the sole purpose of building Quentier&rsquo;s dependencies on Windows and uploading them to the <a href="https://github.com/d1vanov/quentier-dependencies-windows/releases">continuous release</a> from where they can be downloaded.</p>

<h3 id="linux">Linux</h3>

<p>It&rsquo;s hard to write the detailed guide for every possible Linux distribution as there are so many of these so this section will use Ubuntu and apt-get for the sake of example. For other distributions simply use the distribution&rsquo;s native or your preferred package manager and correct the package names accordingly.</p>

<p>First need to make sure the basic development tools are installed:</p>

<pre><code>sudo apt-get install build-essential cmake git doxygen
</code></pre>

<p>Then let&rsquo;s install Qt. Since libquentier and Quentier support building with both Qt4 and Qt5, you can install either version you like more. Here&rsquo;s the command to install Qt4 libraries:</p>

<pre><code>sudo apt-get install libqt4-dev libqt4-dev-bin libqt4-network libqt4-xml libqt4-xmlpatterns libqt4-sql libqt4-sql-sqlite libqt4-test libqt4-dbus libqt4-webkit
</code></pre>

<p>For Qt 5 the equivalent would be the following:</p>

<pre><code>sudo apt-get install qtbase5-dev qttools5-dev libqt5webkit5-dev
</code></pre>

<p>Notice one important detail which is specific to Debian, Ubuntu and all distributions derived from them (with the exception of KDE Neon and possibly some others): the official distro&rsquo;s repositories would probably not contain <code>QtWebEngine</code> which is one of two potential backends of note editor within libquentier. So in these distributions you can only build libquentier with <code>QtWebKit</code> note editor backend <em>unless</em> you use Qt built manually or installed from somewhere else than the distro&rsquo;s official repository. Such unofficial Qt repositories exist, they contain <code>QtWebEngine</code> and you can perfectly use it to build libquentier and Quentier. In fact, Quentier <a href="https://github.com/d1vanov/quentier/blob/master/.travis.yml">uses</a> one unofficial Qt version on Travis CI for packaging into <a href="https://appimage.org">AppImage</a>. <a href="https://launchpad.net/~beineri">Stephan Binner</a> does a great job of setting up launchpad repositories with various Qt versions for different versions of Ubuntu. Feel free to use them. However, bear in mind that if you use unofficial Qt, you&rsquo;d need to build <a href="https://github.com/frankosterfeld/qtkeychain">QtKeychain</a> with that Qt version instead of installing it from the official repository. It&rsquo;s not hard to do and will be explained below.</p>

<p>If you use the distro&rsquo;s native Qt4 version, that&rsquo;s how you install QtKeychain on Ubuntu:</p>

<pre><code>sudo apt-get install qtkeychain-dev
</code></pre>

<p>If you use the distro&rsquo;s native Qt5 version, you can install Qt5Keychain as follows on Ubuntu:</p>

<pre><code>sudo apt-get install qt5keychain-dev
</code></pre>

<p>If you use some unofficial Qt5 version, you need to build Qt5Keychain from source. Here&rsquo;s how it can be done:</p>

<pre><code>git clone https://github.com/frankosterfeld/qtkeychain.git
cd qtkeychain
mkdir build
cd build
cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local
make
sudo make install
</code></pre>

<p>Now let&rsquo;s install non-Qt dependencies:</p>

<pre><code>sudo apt-get install libxml2-dev libboost-dev libboost-program-options-dev libssl-dev libhunspell-dev
</code></pre>

<p>In more recent versions of Debian/Ubuntu (since Debian 9.0 Stretch and since Ubuntu 18.04 Bionic) you can also install tidy-html5 from the official repository:</p>

<pre><code>sudo apt-get install libtidy-dev
</code></pre>

<p>If you use less recent distros, their shipped libtidy version is too old for libquentier, so you need to build the newer version by hand:</p>

<pre><code>git clone https://github.com/htacg/tidy-html5.git
cd tidy-html5
git checkout 5.6.0
mkdir build-tidy
cd build-tidy
cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local
make
sudo make install
</code></pre>

<p>All other dependencies are not shipped in official Debian/Ubuntu distros so these need be built manually.</p>

<p>Let&rsquo;s build Google breakpad which is optional dependency on Linux and Windows. You can skip it and build Quentier without Google breakpad but then you won&rsquo;t get minidump and backtrace if Quentier crashes and hence it would be much harder if not impossible to understand the reason of the crash.</p>

<pre><code>git clone https://chromium.googlesource.com/breakpad/breakpad
cd breakpad
git checkout chrome_64
git clone https://chromium.googlesource.com/linux-syscall-support src/third_party/lss
./configure --prefix=/usr/local
make
sudo make install
</code></pre>

<p>If you intend to build libquentier and Quentier with Qt4, you&rsquo;d need <a href="https://github.com/d1vanov/qt4-mimetypes">qt4-mimetypes</a>. Here&rsquo;s how one can build and install it:</p>

<pre><code>git clone https://github.com/d1vanov/qt4-mimetypes.git
cd qt4-mimetypes
mkdir build
cd build
cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local
make
sudo make install
</code></pre>

<p>Finally, the last required dependency is <a href="https://github.com/d1vanov/QEverCloud">QEverCloud</a>:</p>

<pre><code>git clone https://github.com/d1vanov/QEverCloud.git
cd QEverCloud
mkdir build
cd build
</code></pre>

<p>At this point the build of QEverCloud has several possibilities to continue:</p>

<ul>
<li>If you build it with Qt5 from the official Debian/Ubuntu repositores, you need to pass one additional option to CMake telling it to link with <code>QtWebKit</code> rather than <code>QtWebEngine</code>:
<code>
cmake .. -DUSE_QT5=1 -DUSE_QT5_WEBKIT=1 -DCMAKE_INSTALL_PREFIX=/usr/local
</code></li>
<li>If you build it with unofficial Qt5 having <code>QtWebEngine</code>, you still need to pass in the option telling CMake to search for Qt5 in favour of Qt4:
<code>
cmake .. -DUSE_QT5=1 -DCMAKE_INSTALL_PREFIX=/usr/local
</code></li>
<li>Otherwise you can just give the &ldquo;default&rdquo; CMake command:
<code>
cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local
</code></li>
</ul>

<p>The rest of the build/installation of QEverCloud is as follows:</p>

<pre><code>make
sudo make install
</code></pre>

<p>That&rsquo;s it! Now you are ready to actually build libquentier and/or Quentier. Please proceed to the actual <a href="https://github.com/d1vanov/libquentier/blob/master/INSTALL.md">build</a> <a href="https://github.com/d1vanov/quentier/blob/master/INSTALL.md">instructions</a> for each of them.</p>

<h3 id="mac">Mac</h3>

<p>The instruction for dependencies installation on Mac is quite similar to the one for Linux, only the package manager used in this tutorial would be <a href="https://brew.sh">brew</a> instead of <code>apt-get</code>. If you use <a href="https://www.macports.org">Macports</a> instead of Homebrew, that&rsquo;s fine, you just need to use <code>port</code> instead of <code>brew</code> + some packages might have different names in Macports or some packages might be missing there so you&rsquo;d need to build the corresponding dependencies from source.</p>

<p>If you don&rsquo;t have Homebrew installed and set up yet, go to its <a href="https://brew.sh">site</a> and install and configure it. After that proceed to the following:</p>

<pre><code>brew tap owncloud owncloud/owncloud
brew install git cmake qt5 boost openssl hunspell tidy-html5 qtkeychain doxygen
</code></pre>

<p>The owncloud tap is required for its qtkeychain formula.</p>

<p>Now the only thing which requires manual building from source is QEverCloud. It can be built and installed as follows:</p>

<pre><code>git clone https://github.com/d1vanov/QEverCloud.git
cd QEverCloud
mkdir build
cd build
cmake .. -DUSE_QT5=1 -DCMAKE_INSTALL_PREFIX=/usr/local
make
make install
</code></pre>

<p>That&rsquo;s it! Now you are ready to actually build libquentier and/or Quentier. Please proceed for the actual <a href="https://github.com/d1vanov/libquentier/blob/master/INSTALL.md">build</a> <a href="https://github.com/d1vanov/quentier/blob/master/INSTALL.md">instructions</a> for each of them.</p>

<h3 id="windows">Windows</h3>

<p>Building libquentier and Quentier on Windows is by far the most complex procedure among all the three supported platforms. Building all the prerequisites by hand is hard, especially given that the build procedures are very different between MSVC and MinGW toolchains. The good news is that there are <a href="https://github.com/d1vanov/quentier-dependencies-windows/releases">prebuilt binaries</a> for two MSVC versions - Visual Studio 2015 32 bit and Visual Studio 2017 64 bit - and for 32 bit MinGW 5.3.0. In that repository one can find <a href="https://github.com/d1vanov/quentier-dependencies-windows/blob/master/appveyor.yml">appveyor.yml</a> configuration file describing the build steps for three build configurations - two MSVC ones and one MinGW one.</p>

<p>If you choose to use the prebuilt binaries, the procedure is rather simple: download the binaries for the chosen build configuration and extract them all into the same folder. That folder would then contain <code>include</code>, <code>lib</code>, <code>bin</code> and a bunch of other folders. For building libquentier and Quentier you&rsquo;d need to tell CMake the location of these folders i.e. set <code>CMAKE_PREFIX_PATH</code> to the location of this folder. You would also need to set <code>PATH</code> environment variable to the location of <code>bin</code> folder, <code>INCLUDE</code> environment variable to the location of <code>include</code> folder and <code>LIB</code> environment variable to the location of <code>lib</code> folder.</p>

<p>If you choose to build Quentier dependencies yourself on Windows, good luck! Recall that you can find the exact building steps in <a href="https://github.com/d1vanov/quentier-dependencies-windows/blob/master/appveyor.yml">this appveyor.yml</a> build configuration.</p>

<p>Before getting to the exact building steps, install the necessary software on your Windows machine:</p>

<ul>
<li><a href="https://cmake.org/download">CMake</a></li>
<li><a href="https://git-scm.com/download">Git</a></li>
<li><a href="http://www.paehl.com/open_source/?download=curl_757_0_ssl.zip">curl</a></li>
<li><a href="http://www.7-zip.org">7Zip</a></li>
</ul>

<p>Also, if you intend to build things with Visual Studio, you&rsquo;d need the following additional tools:</p>

<ul>
<li><a href="https://www.activestate.com/activeperl/downloads">Active perl</a></li>
<li><a href="https://www.python.org/downloads/release/python-2714">Python 2.7</a></li>
</ul>

<p>And if you intend to build things with MinGW, you&rsquo;d need</p>

<ul>
<li><a href="http://www.msys2.org">msys64</a> in addition to msys coming with MinGW</li>
<li><a href="https://cygwin.com/install.html">cygwin</a>; it doesn&rsquo;t matter much whether 64 or 32 bits version is used, this tutorial would assume the use of 32 bit version with Cygwin installed to <code>C:\cygwin</code>; the 64 bit Cygwin would by default be installed to <code>C:\cygwin64</code>.</li>
</ul>

<p>One more thing: if you would like the installation step of Quentier to produce the installer, you&rsquo;d need another thirdparty package: <a href="https://nsis.sourceforge.io/Main_Page">NSIS</a>.</p>

<p>Ensure the location of git, CMake, curl and 7z executables (and NSIS&rsquo; makensis if you installed it) are in your <code>PATH</code> environment variable i.e. you can execute git, CMake, curl and 7z commands from the terminal. The installers of git, CMake and 7zip should set <code>PATH</code> automatically but just in case they don&rsquo;t, you can always do this by hand. In any event you&rsquo;d need to add the location of <code>curl</code> executable to your <code>PATH</code> environment variable or alternatively to put <code>curl.exe</code> into <code>C:\Windows\System32</code> folder.</p>

<p>The <code>PATH</code> environement variable can be set from the terminal as follows (assuming that you&rsquo;ve unpacked <code>curl.exe</code> to your Downloads folder):</p>

<pre><code>set PATH=C:\Users\%username%\Downloads;%PATH%
</code></pre>

<p>This would modify the <code>PATH</code> environment variable only for the current terminal session, not permanently. In order to set the environment variable permanently you can use the convenient <a href="https://www.rapidee.com/en/download">Rapid environment editor</a> app.</p>

<p>If you installed Perl and Python, <code>perl</code> and <code>python</code> should be in <code>PATH</code> as well.</p>

<p>One more thing: for Visual Studio 2015 you might need to separately install Microsoft build tools (msbuild) from <a href="https://www.microsoft.com/en-us/download/details.aspx?id=48159">this link</a>.
You also need to ensure msbuild is in your <code>PATH</code>. For Visual Studio 2015 you can add it there as follows:</p>

<pre><code>set PATH=C:\Program Files (x86)\MSBuild\14.0\Bin;%PATH%
</code></pre>

<p>And for Visual Studio 2017 as follows:</p>

<pre><code>set PATH=C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\MSBuild\15.0\Bin;%PATH%
</code></pre>

<p>Now just pick some directory where you can download stuff and step there from the terminal. For example:</p>

<pre><code>cd C:\Users\%username%
md quentier_deps
cd quentier_deps
</code></pre>

<h4 id="building-dependencies-with-visual-studio">Building dependencies with Visual Studio</h4>

<h5 id="preparing-the-environment">Preparing the environment</h5>

<p>While you can use Visual Studio IDE to build each Quentier&rsquo;s dependency, this turotial describes the command line approach instead as it is simpler in some ways.</p>

<p>The very first thing you&rsquo;d need to do for building with Visual Studio from the command prompt is to set up all the necessary environment variables. The exact instructions for this step vary depending on the used Visual Studio version. It is a very simple thing to google up but for the sake of example here are the instructions for Visual Studio 2015: open the command prompt (i.e. <code>cmd.exe</code>) and type there the following:</p>

<pre><code>C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat
</code></pre>

<p>This would set several environment variables required to run Visual Studio&rsquo;s compiler, linker and other build tools. This command would set up the environment for <code>x86</code> i.e. 32 bit builds. If you want to build for 64 bit platform, you need to add one extra argument to the above command:</p>

<pre><code>C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat amd64
</code></pre>

<p>For the sake of another example and to illustrate why the exact instructions vary depending on the used Visual Studio version, here&rsquo;s the command which needs to be run when using Visual Studio 2017 for 64 bit builds:</p>

<pre><code>C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars64.bat
</code></pre>

<p>Now you are ready to start downloading and building the dependencies!</p>

<h5 id="building-boost-program-options-library">Building boost program options library</h5>

<p>Let&rsquo;s get started from <a href="http://www.boost.org">Boost</a> C++ libraries. For libquentier and Quentier only the header-only parts + program options library are required. You can just download prebuilt boost binaries corresponding to your Visual Studio version from <a href="https://boost.teeks99.com">here</a> but if for some reason you want to build the program options library yourself, proceed as follows:</p>

<pre><code>curl -fsSL https://dl.bintray.com/boostorg/release/1.65.0/source/boost_1_65_0.7z -o boost_1_65_0.7z
7z x boost_1_65_0.7z
bootstrap.bat
.\b2 --build-dir=%cd%\build --with-program_options --toolset=msvc-14.0 link=shared address-model=32 runtime-link=shared variant=release,debug --build-type=complete stage
</code></pre>

<p>The <code>toolset</code> option specifies which version of Visual Studio would be used; <code>msvc-14.0</code> corresponds to Visual Studio 2015. Other options include:</p>

<ul>
<li><code>msvc-14.1</code> for Visual Studio 2017</li>
<li><code>msvc-12.0</code> for Visual Studio 2013</li>
<li><code>msvc-11.0</code> for Visual Studio 2012</li>
<li><code>msvc-10.0</code> for Visual Studio 2010</li>
</ul>

<p>I omit the rest of the list as older Visual Studio versions most likely won&rsquo;t be able to build libquentier and Quentier so you shouldn&rsquo;t use them anyway.</p>

<p>Notice the <code>address-model</code> parameter; it should be either of two values: <code>32</code> for 32 bit build or <code>64</code> for 64 bit build.</p>

<p>You can find more information about boost&rsquo;s build system <a href="http://www.boost.org/build/doc/html/index.html">here</a>.</p>

<p>After the build finishes, you&rsquo;d have built program options library within <code>lib</code> directory. For each version of the library (debug and release) there would be two files: <code>.lib</code> and <code>.dll</code> ones. When building Quentier, you might need to specify <code>BOOST_LIBRARYDIR</code> parameter pointing to the <code>lib</code> directory for CMake to find the library.</p>

<p>Another important note: boost 1.65.0 is used in this example for a reason: at the time of this writing more recent version of Boost exists: 1.66.0. Unfortunately, in this version the naming of boost library files has changed but CMake was not ready for that change. As a result, at the time of this writing the latest released CMake (3.10.1) <a href="https://gitlab.kitware.com/cmake/cmake/issues/17575">can&rsquo;t find</a> boost libraries for version 1.66.0.</p>

<h5 id="building-openssl">Building OpenSSL</h5>

<p><a href="https://www.openssl.org">OpenSSL</a> library is used by libquentier for its encryption algorithms and by Qt for secure networking. OpenSSL&rsquo;s building procedure on Windows is quite complex and seems to heavily depend on the version of OpenSSL used for building. You might want to skip the building of OpenSSL and instead just download the prebuilt version, for example, from <a href="https://slproweb.com/products/Win32OpenSSL.html">here</a>. However, note the downloaded OpenSSL might depend on another version of Visual C++ runtime than the version you intend to use for libquentier and/or Quentier. It might be a non-issue if you are building libquentier and Quentier for the purposes of develoment/testing/tinkering. But it would be an issue if you&rsquo;re building Quentier for creating the installer and further distribution of it: the installer currently only attempts to download the version of Visual C++ runtime corresponding to the Visual Studio used to build Quentier but not other versions of the runtime.</p>

<p>Important note about OpenSSL version to use: there are currently two major different versions out there: 1.0 and 1.1. Qt has only become able to work with OpenSSL 1.1 in <a href="https://wiki.qt.io/New_Features_in_Qt_5.10">5.10 release</a>, so it&rsquo;s better to use OpenSSL 1.0 version for now:</p>

<pre><code>git clone https://github.com/openssl/openssl.git
cd openssl
git checkout OpenSSL_1_0_2r
</code></pre>

<p><code>OpenSSL_1_0_2r</code> is the name of the tag which is the latest in OpenSSL 1.0 series at the time of this writing. Look at <a href="https://github.com/openssl/openssl/releases">the official OpenSSL repository&rsquo;s releases</a> to find out whether there is more recent 1.0 version available. If it&rsquo;s available, use the latest version as it might include vital security fixes.</p>

<p>Now let&rsquo;s get to the actual building procedure. It is somewhat different for 32 bit and 64 bit builds so the steps for the two variants would be displayed separately. First, the version for 32 bit build:</p>

<pre><code>perl Configure VC-WIN32 no-asm --prefix=%cd%\installdir
ms\do_ms
nmake -f ms\ntdll.mak
nmake -f ms\ntdll.mak test
nmake -f ms\ntdll.mak install
</code></pre>

<p>That was the release build of OpenSSL. All the built stuff would be installed into the installdir folder within the folder with OpenSSL sources. If you intend to build libquentier and Quentier in &ldquo;Debug&rdquo; or &ldquo;Release with debug info&rdquo; configurations (which is likely if you intend to hack on libquentier and/or Quentier) you&rsquo;d also need to build the debug OpenSSL version - for OpenSSL it is important whether the build is debug or release one due to some quite special handling of exported symbols in different versions. In short, trying to link the debug application with release version of OpenSSL might fail, hence it&rsquo;s better to have debug version as well as release one. Here&rsquo;s how the debug version can be built for 32 bit build:</p>

<pre><code>perl Configure debug-VC-WIN32 no-asm --prefix=%cd%\installdir-dbg
ms\do_ms
nmake -f ms\ntdll
nmake -f ms\ntdll.mak test
nmake -f ms\ntdll.mak install
</code></pre>

<p>Quite similar to the release build, the only difference is the configuration: <code>debug-VC-WIN32</code> instead of just <code>VC-WIN32</code> + another installation dir to prevent intermixing the two versions together.
Now it&rsquo;s better to put the debug libraries near the release ones only you&rsquo;d need to adjust their names to make it easier for CMake to find both debug and release versions:</p>

<pre><code>copy installdir-dbg\lib\libeay32.lib installdir\lib\libeay32d.lib
copy installdir-dbg\lib\ssleay32.lib installdir\lib\ssleay32d.lib
</code></pre>

<p>The 64 bit build instructions are a little different:</p>

<pre><code>perl Configure VC-WIN64A no-asm --prefix=%cd%\installdir
ms\do_win64a
nmake -f ms\ntdll.mak
cd out32dll
..\ms\test
cd ..
nmake -f ms\ntdll.mak install
</code></pre>

<p>and for debug build:</p>

<pre><code>perl Configure debug-VC-WIN64A no-asm --prefix=%cd%\installdir-dbg
ms\do_win64a
nmake -f ms\ntdll.mak
cd out32dll
..\ms\test
cd ..
nmake -f ms\ntdll.mak install
</code></pre>

<p>The same advice for holding debug libraries near the release ones holds for 64 bit as well.</p>

<h5 id="building-libiconv">Building libiconv</h5>

<p>Building libiconv 1.15 with Visual Studio is relatively easy thanks to the efforts of GitHub user <a href="https://github.com/kiyolee">kiyolee</a> who created several repositories for popular originally Unix libraries with build system set up for straightforward building with Visual Studio on Windows. The procedure is as follows:</p>

<pre><code>git clone https://github.com/kiyolee/libiconv-win-build.git
cd libiconv-win-build
</code></pre>

<p>Now need to step into the directory containing the set up build files for the version of Visual Studio you use. There are several options to choose from:</p>

<ul>
<li>build-VS2008</li>
<li>build-VS2010</li>
<li>build-VS2013-MT</li>
<li>build-VS2013</li>
<li>build-VS2015-MT</li>
<li>build-VS2015</li>
<li>build-VS2017-MT</li>
<li>build-VS2017</li>
</ul>

<p>The <code>-MT</code> switch means static linkage to multithreaded Visual C++ runtime. If you plan to distribute the built libquentier and Quentier, be aware that static linking with proprietary runtime library is generally not compatible with LGPL and GPL licenses so it&rsquo;s better to choose some non <code>-MT</code> option.</p>

<p>As this example tutorial uses Visual Studio 2015, picking the corresponding folder:</p>

<pre><code>cd build-VS2015
msbuild libiconv.sln /p:Configuration=&quot;Release&quot; /p:Platform=&quot;Win32&quot;
</code></pre>

<p>The &ldquo;Platform&rdquo; option specifies whether you build 32 bit or 64 bit version of the library; <code>Win32</code> means 32 bit version, <code>x64</code> means 64 bit one.
After the build the library files would be located within &ldquo;Release&rdquo; folder for 32 bit build and within &ldquo;x64\Release&rdquo; folder for 64 bit build:</p>

<ul>
<li>libiconv.lib</li>
<li>libiconv.dll</li>
</ul>

<p>The recommended approach is to copy or move these files somewhere where it&rsquo;d be easy for CMake to find them. For example, within the cloned libiconv-win-build folder you could create some <code>installdir</code> with <code>bin</code> and <code>lib</code> folders inside it. Then move libiconv.dll to <code>bin</code> folder and move libiconv.lib to <code>lib</code> folder. Than you could either specify the path to <code>installdir</code> within <code>CMAKE_PREFIX_PATH</code> or, if you don&rsquo;t plan to build libquentier and/or Quentier with different compilers, you could assign the environment variables making it unnecessary to specify anything during CMake step:</p>

<pre><code>set INCLUDE=%cd%\..\include;%INCLUDE%
set LIB=%cd%\installdir\lib;%LIB%
set PATH=%cd%\installdir\bin;%PATH%
</code></pre>

<h5 id="building-zlib">Building zlib</h5>

<p>Building zlib 1.2.11 with Visual Studio is straightforward thanks again to the efforts of GitHub user <a href="https://github.com/kiyolee">kiyolee</a>:</p>

<pre><code>git clone https://github.com/kiyolee/zlib-win-build.git
cd zlib-win-build
cd build-VS2015
msbuild zlib.sln /p:Configuration=&quot;Release&quot; /p:Platform=&quot;Win32&quot;
</code></pre>

<p>As with libiconv, the resulting binaries would be in &ldquo;Release&rdquo; folder for 32 bit build and in &ldquo;x64\Release&rdquo; folder for 64 bit build. The recommended approach is to put the built <code>.lib</code> and <code>.dll</code> files into relevant folders, as with libiconv (see above). The environment variables making it simple for CMake to locate the libraries are as follows:</p>

<pre><code>set INCLUDE=%cd%\..;%INCLUDE%
set LIB=%cd%\installdir\lib;%LIB%
set PATH=%cd%\installdir\bin;%PATH%
</code></pre>

<h5 id="building-libxml2">Building libxml2</h5>

<p>And once again huge thanks goes to GitHub user <a href="https://github.com/kiyolee">kiyolee</a> for making it really simple to build libxml2 on Windows:</p>

<pre><code>git clone https://github.com/kiyolee/libxml2-win-build.git
cd libxml2-win-build
cd build-VS2015
msbuild libxml2.sln /p:Configuration=&quot;Release&quot; /p:Platform=&quot;Win32&quot;
</code></pre>

<p>As with libiconv and zlib, the resulting binaries would be in &ldquo;Release&rdquo; folder for 32 bit build and in &ldquo;x64\Release&rdquo; folder for 64 bit build. The recommended approach is to put the built <code>.lib</code> and <code>.dll</code> files into relevant folders, as with libiconv (see above). The environment variables making it simple for CMake to locate the libraries are as follows:</p>

<pre><code>set INCLUDE=%cd%\..\include;%INCLUDE%
set LIB=%cd%\installdir\lib;%LIB%
set PATH=%cd%\installdir\bin;%PATH%
</code></pre>

<h5 id="building-libhunspell">Building libhunspell</h5>

<pre><code>git clone https://github.com/hunspell/hunspell.git
cd hunspell
git checkout v1.7.0
msbuild %cd%\msvc\Hunspell.sln /p:Configuration=&quot;Release_dll&quot; /p:Platform=&quot;Win32&quot;
</code></pre>

<p>The 64 bit &ldquo;Platform&rdquo; would be &ldquo;x64&rdquo;, as expected. The location of built binaries is slightly different:</p>

<ul>
<li>msvc\Release_dll\libhunspell\libhunspell.lib</li>
<li>msvc\Release_dll\libhunspell\libhunspell.dll</li>
</ul>

<p>It is for 32 bit build, for 64 bit build these would be found in</p>

<ul>
<li>msvc\x64\Release_dll\libhunspell.lib</li>
<li>msvc\x64\Release_dll\libhunspell.dll</li>
</ul>

<p>As with libiconv, zlib and libxml2, it is recommended to put the built files into relevant folders and set <code>INCLUDE</code>, <code>LIB</code> and <code>PATH</code> environment variables.</p>

<h5 id="building-tidy-html5">Building tidy-html5</h5>

<p>Building tidy-html5 is straightforward thanks to the project&rsquo;s use of CMake build system:</p>

<pre><code>git clone https://github.com/htacg/tidy-html5.git
cd tidy-html5
git checkout 5.6.0
md build-tidy
cd build-tidy
cmake .. -G &quot;NMake Makefiles&quot; -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIB=ON -DCMAKE_INSTALL_PREFIX=&quot;%cd%\installdir&quot;
cmake --build . --target all
cmake --build . --target install
</code></pre>

<p>And that&rsquo;s all. The resulting binaries as well as development headers would be located in build-tidy/installdir folder. You&rsquo;d need to add it to <code>CMAKE_PREFIX_PATH</code> when building libquentier and/or Quentier. Or alternatively you can add installdir/bin to <code>PATH</code>, installdir/lib to <code>LIB</code> and installdir/include to <code>INCLUDE</code> environment variables.</p>

<h5 id="building-qtkeychain">Building qtkeychain</h5>

<p>QtKeychain library has some peculiarities on Windows so here are the detailed build instructions:</p>

<pre><code>git clone https://github.com/frankosterfeld/qtkeychain.git
cd qtkeychain
git checkout v0.9.1
</code></pre>

<p>By default QtKeychain on Windows 7 and higher uses <a href="https://www.digitalcitizen.life/credential-manager-where-windows-stores-passwords-other-login-details">Credential Store</a>. However, I encountered some problems getting it to work with libquentier and hence decided to use another option: keeping the data within <a href="https://doc.qt.io/qt-5/qsettings.html">QSettings</a> but encrypted using WinAPI function <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa380261%28v=vs.85%29.aspx">CryptProtectData</a> with the user&rsquo;s logon credentials. In addition, in this mode the built Quentier app might even work on Windows older than 7 i.e. XP.</p>

<p>Here are the steps required to build QtKeychain:</p>

<pre><code>md build
cd build
cmake .. -G &quot;NMake Makefiles&quot; -DCMAKE_BUILD_TYPE=Release -DUSE_CREDENTIAL_STORE=OFF -DCMAKE_INSTALL_PREFIX=&quot;%cd%\installdir&quot;
</code></pre>

<p>If CMake complains about not finding Qt, add `-DCMAKE_PREFIX_PATH=&rdquo;<path to Qt installation>&rdquo; to the above command.</p>

<pre><code>cmake --build . --target all
cmake --build . --target install
</code></pre>

<p>That&rsquo;s it, after this step the necessary binaries as well as development headers would be within build/installdir folder. The recipe for using them for building libquentier and/or Quentier with either <code>CMAKE_PREFIX_PATH</code> or <code>PATH</code>/<code>LIB</code>/<code>INCLUDE</code> is the same as above.</p>

<h5 id="building-google-breakpad">Building Google breakpad</h5>

<p>Building Google breakpad on Windows is a very painful experience because the process is not really well documented and, furthermore, building the project on Windows is maintained surprisingly poorly by Google. But don&rsquo;t lose hope, it is still possible to build this thing and here are the instructions:</p>

<pre><code>git clone https://chromium.googlesource.com/breakpad/breakpad
cd breakpad
git checkout chrome_64
cd src
git clone https://github.com/google/googletest.git testing
cd ..\..
git clone https://chromium.googlesource.com/external/gyp
cd gyp
python setup.py install
cd ..\breakpad
md installdir
md installdir\include\breakpad\client\windows
md installdir\include\breakpad\common\windows
md installdir\lib
md installdir\bin
xcopy src installdir\include\breakpad /e
</code></pre>

<p>The last line from the above copies almost entire sources of breakpad into the installation prefix&rsquo;s include folder. That might be overkill but hand picking the headers which really need to be present there is too much trouble so this simple hack works.</p>

<p>At this point you need to patch the gyp project file to make breakpad buildable on Windows. You can either do it by hand using any text editor or using <code>sed</code> from <code>msys64</code>: within &ldquo;breakpad/src/build&rdquo; folder there&rsquo;s a file called <code>common.gypi</code>. Inside this file you need to replace all occurrences of <code>'WarnAsError': 'true'</code> with <code>'WarnAsError': 'false'</code>. This setting controls whether the compiler would treat warnings as build errors or not. Some warnings do exist when building on Windows so in the default configuration the build can&rsquo;t succeed. Here&rsquo;s how this setting can be changed with the help of sed editor:</p>

<pre><code>C:\msys64\usr\bin\bash -lc &quot;cd /c/dev/breakpad/src/build &amp;&amp; sed -i -e \&quot;s/'WarnAsError': 'true'/'WarnAsError': 'false'/g\&quot; common.gypi&quot;
</code></pre>

<p>Replace the path to breakpad dir with your actual one in the above command.
Now can proceed building the breakpad. Will start from the client libraries and will do two builds, in release and debug configurations:</p>

<pre><code>..\gyp\gyp.bat src\client\windows\breakpad_client.gyp --no-circular-check -Dwin_release_RuntimeLibrary=2 -Dwin_debug_RuntimeLibrary=3
cd src\client\windows
msbuild breakpad_client.sln /p:Configuration=&quot;Release&quot; /p:Platform=&quot;Win32&quot;
msbuild breakpad_client.sln /p:Configuration=&quot;Debug&quot; /p:Platform=&quot;Win32&quot;
</code></pre>

<p>For 64 bit build set the &ldquo;Platform&rdquo; parameter to &ldquo;x64&rdquo;. The built release binaries can be found within Release/lib folder and debug ones within Debug/lib one. Copy them to the installation dir while adding the <code>\_d</code> suffix for debug libraries:</p>

<pre><code>copy Release\lib\common.lib ..\..\..\installdir\lib
copy Release\lib\crash_generation_client.lib ..\..\..\installdir\lib
copy Release\lib\crash_generation_server.lib ..\..\..\installdir\lib
copy Release\lib\exception_handler.lib ..\..\..\installdir\lib
copy Debug\lib\common.lib ..\..\..\installdir\lib\common_d.lib
copy Debug\lib\crash_generation_client.lib ..\..\..\installdir\lib\crash_generation_client_d.lib
copy Debug\lib\crash_generation_server.lib ..\..\..\installdir\lib\crash_generation_server_d.lib
copy Debug\lib\exception_handler.lib ..\..\..\installdir\lib\exception_handler_d.lib
</code></pre>

<p>Now need to build <code>dump_syms</code> utility which would then be used during the build of Quentier for the extraction of symbols from Quentier executable and libquentier library - these symbols would then be used to produce stack traces during crash handling. The end users would then be able to provide the stack traces while reporting crashes - these can be used as minimal hints to the reason of the crash. Without crash handling every single crash is like a shot in the dark - you can&rsquo;t say who did it or why.</p>

<pre><code>cd ..\..\..
..\gyp\gyp.bat src\tools\windows\tools_windows.gyp --no-circular-check -Dwin_release_RuntimeLibrary=2 -Dwin_debug_RuntimeLibrary=3
cd src\tools\windows
msbuild tools_windows.sln /p:Configuration=&quot;Release&quot; /p:Platform=&quot;Win32&quot;
</code></pre>

<p>After it&rsquo;s built copy it to the installation prefix&rsquo;s bin directory:</p>

<pre><code>copy Release\dump_syms.exe ..\..\..\installdir\bin
</code></pre>

<p>The final touch: need one other executable, <code>minidump_stackwalk</code>. It is the executable which parses the minidump produced by the crashing app using the symbols created by <code>dump_syms</code>. It seems Google has never planned for this executable to be used - or even built - on Windows because currently the only way to build this tool on Windows is using Cygwin (thus depending on its dlls). Thankfully, guys from Mozilla have already done that so this tool can just be downloaded from Mozilla servers:</p>

<pre><code>curl -fsSL http://hg.mozilla.org/build/tools/raw-file/755e58ebc9d4/breakpad/win32/minidump_stackwalk.exe -o minidump_stackwalk.exe
curl -fsSL http://hg.mozilla.org/build/tools/raw-file/755e58ebc9d4/breakpad/win32/cygwin1.dll -o cygwin1.dll
curl -fsSL http://hg.mozilla.org/build/tools/raw-file/755e58ebc9d4/breakpad/win32/cygstdc++-6.dll -o cygstdc++-6.dll
curl -fsSL http://hg.mozilla.org/build/tools/raw-file/755e58ebc9d4/breakpad/win32/cyggcc_s-1.dll -o cyggcc_s-1.dll
</code></pre>

<p>If you feel inclined, in <a href="https://groups.google.com/forum/#!topic/google-breakpad-discuss/B4xza0jGdlY">this thread</a> some guy describes what to change in breakpad sources to make <code>minidump_stackwalk</code> utility buildable on Windows with Visual C++. You can follow this description to try and build <code>minidump_stackwalk</code> on Windows with Visual C++.</p>

<p>That was the last dependency so the guide for building Quentier and/or libquentier dependencies on Windows using Visual Studio is finished now!</p>

<h4 id="building-dependencies-with-mingw">Building dependencies with MinGW</h4>

<p>Building the dependencies of Quentier and/or libquentier with MinGW on Windows is a suffiicently different experience from building with Visual C++. At some points it&rsquo;s simpler but at other points it&rsquo;s harder.</p>

<p>This tutorial would assume you build stuff with the <a href="http://mingw.org">official MinGW</a> version, not <a href="http://mingw-w64.org">mingw-w64</a>; the latter might work too but it was not tested i.e. currently MinGW build of libquentier and Quentier has only been tested in 32 bit mode.</p>

<p>Ensure MinGW&rsquo;s compilers and tools are in your <code>PATH</code> environment variable, by doing this:</p>

<pre><code>set PATH=C:\MinGW\bin;%PATH%
</code></pre>

<h5 id="building-boost-program-options-library-1">Building boost program options library</h5>

<p>Let&rsquo;s get started from <a href="http://www.boost.org">Boost</a> C++ libraries. For libquentier and Quentier only the header-only parts + program options library is required. It doesn&rsquo;t seem like prebuilt MinGW versions of boost are available somewhere on the Internet so need to build them from source:</p>

<pre><code>curl -fsSL https://dl.bintray.com/boostorg/release/1.65.0/source/boost_1_65_0.7z -o boost_1_65_0.7z
7z x boost_1_65_0.7z
bootstrap.bat gcc
.\b2 --build-dir=%cd%\build --with-program_options --toolset=gcc link=shared address-model=32 runtime-link=shared variant=release,debug --build-type=complete stage
</code></pre>

<p>You can find more information about boost&rsquo;s build system <a href="http://www.boost.org/build/doc/html/index.html">here</a>.</p>

<p>After the build finishes, you&rsquo;d have built program options library within <code>lib</code> directory. For each version of the library there would be two files: <code>.lib</code> and <code>.dll</code> ones. When building Quentier, you might need to specify <code>BOOST_LIBRARYDIR</code> parameter pointing to the <code>lib</code> directory for CMake to find the library.</p>

<h5 id="building-openssl-1">Building OpenSSL</h5>

<p><a href="https://www.openssl.org">OpenSSL</a> library is used by libquentier for its encryption algorithms and by Qt itself for secure networking. OpenSSL&rsquo;s building procedure on Windows is quite complex and seems to heavily depend on the version of OpenSSL used for building. You might want to skip the building of OpenSSL and instead just download the prebuilt version, for example, from <a href="https://slproweb.com/products/Win32OpenSSL.html">here</a>. The versions at the link were built with Visual C++ but thanks to the lack of <a href="https://en.wikipedia.org/wiki/Name_mangling">name mangling</a> for code written in C programming language, the OpenSSL libraries built by MinGW and Visual C++ can be used interchangeably. However, note that it is the exception rather than the rule - in general libraries/executables built by different compilers cannot be used together. Also note that the downloaded OpenSSL would depend on some version of Visual C++ runtime. It might be a non-issue if you are building libquentier and Quentier for the purposes of develoment/testing/tinkering. But it would be an issue if you&rsquo;re building Quentier for creating the installer and distributing it: for MinGW builds the installer currently doesn&rsquo;t offer the option to download any version of Visual C++ runtime.</p>

<p>Important note about OpenSSL version to use: there are currently two major different versions out there: 1.0 and 1.1. Qt has only become able to work with OpenSSL 1.1 in <a href="https://wiki.qt.io/New_Features_in_Qt_5.10">5.10 release</a>, so it&rsquo;s better to use OpenSSL 1.0 version for now:</p>

<pre><code>git clone https://github.com/openssl/openssl.git
cd openssl
git checkout OpenSSL_1_0_2r
</code></pre>

<p><code>OpenSSL_1_0_2r</code> is the name of the tag which is the latest in OpenSSL 1.0 series at the time of this writing. Look at the official OpenSSL repository&rsquo;s <a href="https://github.com/openssl/openssl/releases">releases</a> to find out whether there is more recent 1.0 version available. If it&rsquo;s available, use the latest version as it might include vital security fixes.</p>

<p>Here&rsquo;s how you can build OpenSSL with MinGW in a single command:</p>

<pre><code>C:\MinGW\msys\1.0\bin\bash -lc &quot;cd /c/dev/openssl &amp;&amp; ./Configure shared mingw --prefix=/c/dev/openssl/installdir &amp;&amp; make depend &amp;&amp; make &amp;&amp; make test &amp;&amp; make install&quot;
</code></pre>

<p>Replace <code>/c/dev/openssl</code> with the actual directory into which you cloned OpenSSL sources. The resulting binaries as well as development headers would be in <code>installdir</code> folder after this command.</p>

<h5 id="building-libiconv-1">Building libiconv</h5>

<pre><code>md libiconv-win-build
cd libiconv-win-build
curl -fsSL https://ftp.gnu.org/pub/gnu/libiconv/libiconv-1.15.tar.gz -o libiconv-1.15.tar.gz
7z x libiconv-1.15.tar.gz
7z x libiconv-1.15.tar
del libiconv-1.15.tar
del libiconv-1.15.tar.gz
cd libiconv-1.15
C:\cygwin\bin\bash -lc &quot;cd /cygdrive/c/dev/libiconv-win-build/libiconv-1.15 &amp;&amp; export PATH=/usr/local/mingw32/bin:$PATH &amp;&amp; ./configure --host=i686-w64-mingw32 --prefix=$(pwd)/installdir CC=i686-w64-mingw32-gcc CPPFLAGS='-I/usr/local/mingw32/include -Wall' LDFLAGS='-L/usr/local/mingw32/lib' &amp;&amp; make &amp;&amp; make check &amp;&amp; make install&quot;
</code></pre>

<p>Replace <code>/cygdrive/c/dev/libiconv-win-build</code> in the above command with the actual Cygwin path to the created <code>libiconv-win-build</code> directory.</p>

<h5 id="building-zlib-1">Building zlib</h5>

<pre><code>md zlib-win-build
cd zlib-win-build
curl -fsSL https://zlib.net/zlib-1.2.11.tar.gz -o zlib-1.2.11.tar.gz
7z x zlib-1.2.11.tar.gz
7z x zlib-1.2.11.tar
del zlib-1.2.11.tar
del zlib-1.2.11.tar.gz
cd zlib-1.2.11
C:\MinGW\bin\mingw32-make.exe install -f win32\Makefile.gcc INCLUDE_PATH=%cd%\installdir\include BINARY_PATH=%cd%\installdir\bin LIBRARY_PATH=%cd%\installdir\lib SHARED_MODE=1
</code></pre>

<p>The resulting binaries and development headers would be within <code>installdir</code> directory inside <code>zlib-1.2.11</code> directory.</p>

<h5 id="building-libxml2-1">Building libxml2</h5>

<pre><code>git clone https://gitlab.gnome.org/GNOME/libxml2.git
cd libxml2
git checkout v2.9.7
cd win32
</code></pre>

<p>Now need to do one trick: change the extension of the import library from <code>.lib</code> to <code>.dll.a</code> as the latter one is more appropriate for MinGW built library:</p>

<pre><code>C:\msys64\usr\bin\bash -lc &quot;cd /c/dev/libxml2/win32 &amp;&amp; sed -i -e s/\$\(XML_BASENAME\)\.lib/\$\(XML_BASENAME\).dll.a/g Makefile.mingw&quot;
</code></pre>

<p>Replace <code>/c/dev/libxml2</code> in the above command with your actual <code>libxml2</code> folder.</p>

<p>One other trick is required to ensure the development headers of libiconv and the library are seen during the build of libxml2 and nothing gets in between:</p>

<pre><code>set INCLUDEBAK=%INCLUDE%
set INCLUDE=-Ic:/dev/libiconv-win-build/libiconv-1.15/installdir/include
set LIBBAK=%LIB%
set LIB=-Lc:/dev/libiconv-win-build/libiconv-1.15/installdir/lib
</code></pre>

<p>Replace <code>c:/dev/libiconv-win-build</code> in the above commands with your actual path to <code>libiconv-win-build</code>.
Now can continue with building libxml2:</p>

<pre><code>cscript configure.js compiler=mingw prefix=%cd%\installdir debug=no http=no ftp=no
C:\MinGW\bin\mingw32-make.exe install -f Makefile.mingw
</code></pre>

<p>After the build is done, you can return back the contents of <code>INCLUDE</code> and <code>LIB</code> environment variables:</p>

<pre><code>set INCLUDE=%INCLUDEBAK%
set LIB=%LIBBAK%
</code></pre>

<p>One other detail: the build just done has created</p>

<ul>
<li>shared library - libxml2.dll</li>
<li>import library - libxml2.dll.a</li>
<li>static library - libxml2.a</li>
</ul>

<p>CMake seems to prefer static library over the shared one if both are available. If you intend to build libquentier and Quentier for the purposes of development/testing/tinkering, it doesn&rsquo;t matter much which version would be used. However, for distribution purposes it&rsquo;s better to stick with the shared library. The simple way to enforce its use is to delete the just built static library:</p>

<pre><code>del installdir\lib\libxml2.a
</code></pre>

<h5 id="building-libhunspell-1">Building libhunspell</h5>

<pre><code>git clone https://github.com/hunspell/hunspell.git
cd hunspell
git checkout v1.6.2
</code></pre>

<p>A small patch is required to get libhunspell building with MinGW. Apply it along with building and installing the library:</p>

<pre><code>C:\msys64\usr\bin\bash -lc &quot;cd /c/dev/hunspell &amp;&amp; autoreconf -i &amp;&amp; sed -i -e s/\ \|\ S_IRWXG\ \|\ S_IRWXO//g src/tools/hzip.cxx &amp;&amp; CC=C:/MinGW/bin/gcc CXX=C:/MinGW/bin/g++ ./configure --prefix=$(pwd)/installdir --host=i386-unknown-mingw32 &amp;&amp; make &amp;&amp; make check &amp;&amp; make install&quot;
</code></pre>

<p>Replace <code>/c/dev/hunspell</code> in the above command with your actual path to <code>hunspell</code> directory. The resulting binaries as well as development headers would be within <code>installdir</code> folder within <code>hunspell</code> folder.
You can read more about why the patch is required <a href="https://github.com/hunspell/hunspell/issues/463">here</a> and <a href="http://mingw.5.n7.nabble.com/S-IRWXG-S-IRWXO-undefined-when-building-gcc-4-9-2-with-mingwrt-3-20-td34227.html">here</a>.</p>

<h5 id="building-tidy-html5-1">Building tidy-html5</h5>

<p>Building tidy-html5 with MinGW is very similar to building it with MSVC thanks to the project&rsquo;s use of CMake build system:</p>

<pre><code>git clone https://github.com/htacg/tidy-html5.git
cd tidy-html5
git checkout 5.6.0
md build-tidy
cd build-tidy
</code></pre>

<p>Need to deal with one odd thing before continuing: CMake sometimes stops and complains during the generation of MinGW makefiles about the presence of <code>sh.exe</code> within <code>PATH</code> environment variable; the <code>sh.exe</code> CMake doesn&rsquo;t like is typically the one from the Git installation. To work around this problem, can temporarily remove git folder from <code>PATH</code>:</p>

<pre><code>set PATH=%PATH:C:\Program Files\Git\usr\bin;=%
</code></pre>

<p>Now can proceed:</p>

<pre><code>cmake .. -G &quot;MinGW Makefiles&quot; -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIB=ON -DCMAKE_INSTALL_PREFIX=&quot;%cd%\installdir&quot;
cmake --build . --target all
cmake --build . --target install
</code></pre>

<p>The resulting binaries as well as development headers would be located in build-tidy/installdir folder.</p>

<p>Don&rsquo;t forget to return git back to <code>PATH</code>:</p>

<pre><code>set PATH=%PATH%;C:\Program Files\Git\usr\bin
</code></pre>

<h5 id="building-qtkeychain-1">Building qtkeychain</h5>

<pre><code>git clone https://github.com/frankosterfeld/qtkeychain.git
cd qtkeychain
git checkout v0.9.1
</code></pre>

<p>One patch is required for building with MinGW:</p>

<pre><code>C:\msys64\usr\bin\bash -lc &quot;cd /c/dev/qtkeychain &amp;&amp; sed -i s/SecureZeroMemory/ZeroMemory/g keychain_win.cpp&quot;
</code></pre>

<p>Note that this patch might have consequences for qtkeychain&rsquo;s security: some C++ compilers might optimize away the call to <code>ZeroMemory</code> but not the call to <code>SecureZeroMemory</code>. You might want to apply a more proper patch emulating <code>SecureZeroMemory</code> missing in MinGW, see <a href="http://www.programmingforums.org/post94456.html">this</a> to get started.</p>

<p>As with tidy-html5, need to work around CMake&rsquo;s problem with <code>sh.exe</code> within <code>PATH</code>:</p>

<pre><code>set PATH=%PATH:C:\Program Files\Git\usr\bin;=%
</code></pre>

<p>Now can proceed to building qtkeychain for MinGW:</p>

<pre><code>md build
cd build
cmake .. -G &quot;MinGW Makefiles&quot; -DCMAKE_BUILD_TYPE=Release -DUSE_CREDENTIAL_STORE=OFF -DCMAKE_INSTALL_PREFIX=&quot;%cd%\installdir&quot;
</code></pre>

<p>If CMake complains about not finding Qt, add `-DCMAKE_PREFIX_PATH=&rdquo;<path to Qt installation>&rdquo; to the above command.</p>

<pre><code>cmake --build . --target all
cmake --build . --target install
</code></pre>

<p>Now returning git back to <code>PATH</code>:</p>

<pre><code>set PATH=%PATH%;C:\Program Files\Git\usr\bin
</code></pre>

<p>That was currently the last dependency for MinGW as Google breakpad is not integrated into MinGW version of Quentier at the moment.</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://d1vanov.github.io/quentier/blog/quentier-technical-overview/">
        Quentier internals overview
      </a>
    </h1>

    <span class="post-date">Jan 7, 2018</span>

    
      
      <p class="seriesname">Series: <a href="https://d1vanov.github.io/quentier/series/developers-guide">Developers guide</a></p>
    


    <p>This post is primarily for developers who would like to contribute to Quentier but aren&rsquo;t quite sure where to start. Here the high-level overview of the app design is explained.</p>

<p>First, let&rsquo;s briefly enumerate the kinds of technology used in Quentier project:</p>

<ul>
<li>Qt/C++</li>
<li>CMake</li>
<li>SQLite</li>
<li>JavaScript</li>
<li>CSS (a bit)</li>
</ul>

<p>If you are familiar with any of these technologies, you are most likely able to help developing Quentier! However, note that there are some specific ways in which these technologies are used in the project. For example, currently the list of supported Qt versions ranges from Qt 4.8.6 to the latest and greatest Qt 5.x. However, Qt 4.8.6 is only really supported on Linux while on Windows and on Mac it&rsquo;s much more reasonable to use newer Qt 5.x.</p>

<p>Another point is that even though C++ is known as a hard to grasp language for system programmers, in Quentier project only a relatively simple subset of it is used - the use of exceptions is very limited, most part of the code is written in C++98 style with only a handful of features from C++11 standard employed. That makes is possible to build Quentier using as old compilers as gcc-4.5 or Visual C++ 2010. In future the support for such old compilers is going to be dropped at some point though in order to use more useful features from mode recent C++ standards.</p>

<p>The core functionality of Quentier is encapsulated in <a href="https://github.com/d1vanov/libquentier">libquentier</a> library which is distributed under the terms of GNU LGPL v.3. It has no tight bindings to Quentier application (otherwise it won&rsquo;t make much sense to make it a separate library at all) so it can be used by other applications as well. Libquentier provides the following essential functionality:</p>

<ol>
<li>Local storage of notes, notebooks, tags, saved searches, resources. The data elements of each kind can be added, updated, removed, listed, looked up etc.</li>
<li>Synchronization of data from local storage with Evernote servers. Both full and partial synchronization algorithms are implemented.</li>
<li>Note editor UI component which enables one to view and edit notes.</li>
<li>Conversion between ENML and HTML used for presenting notes within the note editor.</li>
<li>A bunch of utility functions and classes.</li>
</ol>

<p>Libquentier&rsquo;s functionality is in turn based on <a href="https://github.com/d1vanov/QEverCloud">QEverCloud</a> library which essentially is the Qt-friendly replacement of the official Evernote C++ SDK: QEverCloud handles the transmission of data between Evernote servers and the outside world and also offers nice Qt-friendly API. A large part of QEverCloud&rsquo;s code was generated automatically from <a href="https://github.com/evernote/evernote-thrift">Evernote thrift IDL files</a>. IDL stands for &ldquo;interface definition language&rdquo;. Thrift was originally invented within Facebook and later on was contributed to Apache Foundation. Thrift IDL is a thing like pseudo-code only it focuses on the definitions of structs instead of commands. Thrift IDL code itself is not compiled into executable code but it can be parsed and converted to code in some real programming language. Normally the generation of code in real programming language is performed by <a href="https://thrift.apache.org/https://thrift.apache.org">thrift compiler</a> but it doesn&rsquo;t have a Qt-friendly C++ backend so QEverCloud&rsquo;s sources are generated using a custom tool - <a href="https://github.com/d1vanov/QEverCloudGenerator">QEverCloudGenerator</a>. The Qt-friendliness of the generated code means that all the most convenient Qt&rsquo;s data types are used instead of their plain C++ counterparts so no conversion between different data types needs to be done. Most notably <code>QString</code> is used instead of <code>std::string</code>.</p>

<p>The local storage within libquentier uses SQLite as its backend i.e. all user&rsquo;s data is stored within a SQLite database. However, it is just an implementation detail, the fact of SQLite usage is completely hidden from libquentier&rsquo;s public API. So in theory is is possible to change the database backend in future to whatever one is considered better - even to storage of plain text files. Internally SQLite is used via Qt&rsquo;s <code>QtSql</code> module.</p>

<p>The synchronization is implemented according to <a href="https://dev.evernote.com/media/pdf/edam-sync.pdf">Evernote&rsquo;s document</a>. That document explains a lot of details but some non-obvious subtleties are not mentioned, unfortunately, so I plan to write more about them in further posts. The synchronization of user&rsquo;s own accounts, public notebooks and notebooks shared by other users is fully supported.</p>

<p>Note editor is a very special thing within libquentier: it is unfortunately quite a complex collection of C++ classes, JavaScript code and a bit of CSS. The complexity of the note editor code comes primarily from the unexpected move of Qt devs who decided to deprecate QtWebKit in favour of QtWebEngine. I decided to support both backends after the semi-complete implementation of QtWebKit based note editor. As a result, note editor&rsquo;s source code has become full of ifdefs slitting the logical branches between the two alternative backends. Another source of complexity is the support for advanced &ldquo;smart&rdquo; undo-redo stack as well as various convenient actions like resizing images, resizing table columns etc.</p>

<p>ENML converter serves the needs of the note editor: it performs the conversion between <a href="https://dev.evernote.com/doc/articles/enml.php">ENML</a> which is Evernote&rsquo;s format for note content storage and HTML. Currently this converter has some hardcoded parts to best serve the needs of the note editor. It would be nice to add some configurability to it in future.</p>

<p>Quentier app&rsquo;s source code is mostly about handling various aspects of user interface and orchestration of work performed by the code within libquentier. Here are the primary parts of Quentier app&rsquo;s code:</p>

<ol>
<li><code>AccountManager</code>: this class controls the discovery of available and last used accounts, switching between accounts and other account management details.</li>
<li><code>MainWindow</code>: this class is the central class within the entire app and it represents, as its name suggests, the main window of Quentier app. It also works as the mediator between several other classes.</li>
<li><code>NoteEditorTabsAndWindowsCoordinator</code>: this class maintains the list of open note editor widgets, both tabbed ones and editors in separate windows. For performance and memory consumption concerns tabbed note editor widgets are automatically closed as new tabbed note editors are opened i.e. the <a href="https://en.wikipedia.org/wiki/Cache_replacement_policies#Least_Recently_Used_(LRU)">LRU cache</a> of tabbed note editors is maintained. The contents of automatically closed note editor tabs are automatically saved, of course, so no loss of data occurs.</li>
<li><code>SystemTrayIconManager</code>: this class, as its name suggests, maintains the Quentier&rsquo;s system tray icon and handles various actions which might be requested from the tray icon&rsquo;s context menu.</li>
<li><code>EnexExporter</code> and <code>EnexImporter</code> are two helper classes which orchestrate the libqentier&rsquo;s code performing export and import of notes to and from data in ENEX format.</li>
<li>Models: classes from <code>src/models</code> folder within Quentier&rsquo;s source tree. These are models in <a href="https://doc.qt.io/qt-5/model-view-programming.html">Qt&rsquo;s model-view framework</a> sense: each is a subclass of <a href="https://doc.qt.io/qt-5/qabstractitemmodel.html">QAbstractItemModel</a>. There are several such classes:

<ul>
<li><code>FavoritesModel</code> - contains data about favorited data items within the current account</li>
<li><code>NotebookModel</code> - contains data about notebooks within the current account</li>
<li><code>TagModel</code> - contains data about tags within the current account</li>
<li><code>SavedSearchModel</code> - contains data about saved searches within the current account</li>
<li><code>NoteModel</code> - contains data about notes within the current account</li>
<li><code>NoteFilterModel</code> - subclass of <a href="https://doc.qt.io/qt-5/qabstractitemmodel.html">QSortFilterProxyModel</a>, implements filtering over the list of notes (sorting is implemented within the <code>NoteModel</code> itself)</li>
<li><code>LogViewerModel</code> - subclass of <a href="https://doc.qt.io/qt-5/qabstracttablemodel.html">QAbstractTableModel</a>, contains data parsed from Quentier&rsquo;s log file; serves for convenient visual presentation of the log file&rsquo;s contents</li>
</ul></li>
<li>Views: classes from <code>src/views</code> folder within Quentier&rsquo;s source tree. These are views in <a href="https://doc.qt.io/qt-5/model-view-programming.html">Qt&rsquo;s model-view framework</a> sense: each is a subclass of <a href="https://doc.qt.io/qt-5/qtreeview.html">QTreeView</a> or <a href="https://doc.qt.io/qt-5/qlistview.html">QListView</a>. There are several such classes:

<ul>
<li><code>ItemView</code> - intermediate helper class within the inheritance chain between <code>QTreeView</code> and particular Quentier&rsquo;s view classes</li>
<li><code>NotebookItemView</code> - implements various actions available via context menu on notebooks from this view as well as special behaviour on notebook selection - the list of notes is filtered by the currently selected notebook unless it is a linked notebook (which is the current technical limitation due to the possibility of name clashes between notebooks from user&rsquo;s own account and linked notebooks or between different linked notebooks)</li>
<li><code>TagItemView</code> - implements various actions available via context menu on tags from this view</li>
<li><code>SavedSearchItemView</code> - implements various actions available via context menu on saved searches from this view</li>
<li><code>DeletedNoteItemView</code> - implements various actions available via context menu on deleted notes from this view</li>
<li><code>NoteListView</code> - implements various actions available via context menu on non-deleted notes from this view</li>
</ul></li>
<li>Delegates: classes from <code>src/delegates</code> folder within Quentier&rsquo;s source tree. These are delegates in <a href="https://doc.qt.io/qt-5/model-view-programming.html">Qt&rsquo;s model-view framework</a> sense: each is a subclass of <a href="https://doc.qt.io/qt-5/qstyleditemdelegate.html">QStyledItemDelegate</a> and implements customized rendering and/or editing of items corresponding to a particular view. I won&rsquo;t list them here since basically each mentioned view has its own delegate + there are some other delegates which are best understood by looking at how and where they are used within Quentier&rsquo;s source code.</li>
</ol>

<p>To put things into perspective, Quentier primarily consists of three large parts:</p>

<ol>
<li>Local storage</li>
<li>Synchronization</li>
<li>UI</li>
</ol>

<p>These three parts interact with each other, primarily asynchronously, via signals and slots. Local storage and synchronization operate within their own threads of execution, the UI is processed primarily in the main (GUI) thread so the operations inside it need to be fast.</p>

<p>That wraps up the brief technical overview. I intend to write more detailed posts about each of the mentioned parts so stay tuned.</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://d1vanov.github.io/quentier/blog/quentier-brief-overview/">
        Brief overview of Quentier features
      </a>
    </h1>

    <span class="post-date">Dec 16, 2017</span>

    


    

<p>In this post I describe in more details what Quentier app is capable of by the current moment.</p>

<p>First of all, please note that at the time of this writing Quentier is in public alpha stage. That means the project is very fresh, some things are unpolished while some other things might just refuse to work due to some unforeseen circumstances. It is pretty normal to go through this stage for any new software project, just be aware of that and dont expect too much from the current version. Also please report the discovered issues to the projects <a href="https://github.com/d1vanov/quentier/issues">issue tracker</a>.</p>

<h3 id="accounts">Accounts</h3>

<p>Quentier as a note taking app can work in two modes: it can either work with <strong>local</strong> accounts or with Evernote accounts. That means you are not obliged to have Evernote account if all you want to do is managing notes with Quentier on just a single computer. Or maybe even on several computers provided that you either copy the data between computers manually or you keep the local account data on a USB stick which you mount to different computers. The latter option requires that you start Quentier with <code>--storageDir &lt;path&gt;</code> command line parameter pointing at the location of your account data. By default, if no such command line option is specified, Quentier keeps its persistent data at the following locations depending on the platform the app runs on:</p>

<ul>
<li><code>~/.quentier</code> on Linux</li>
<li><code>~/Library/Application Support/quentier.org/Quentier</code> on OS X / macOS</li>
<li><code>C:\Users\%USERNAME%\AppData\Roaming\Quentier</code> on Windows</li>
</ul>

<p>At the moment Quentier works best when only a single instance of the application is running at any moment of time. There are some protection measures against having two app instances working with the same account, however, right now if you try hard enough you might be able to fool them. It is possible to run several instances of the application working with different accounts, however, it might not work on Windows and it might screw up the usefulness of logging on other platforms since currently all instances of Quentier attempt to write logs into the same log file.</p>

<p>The preferred way to work with different accounts is to have a single instance of the application running and to switch between accounts as necessary: that can be done by opening File menu and choosing one of Switch account submenus options. Note that most of different settings and preferences within Quentier are persistent and account-specific. Even the relative sizes of main windows parts are persisted and restored on per account basis.</p>

<p>When you open Quentier app for the first time, it would ask you what would you like to do: use the app for local note-taking or use it as Evernote client. The local account is created for you automatically and even if you choose to use Quentier as Evernote client, you can still switch back to the local account later. You can also create as many local and Evernote accounts as you wish and switch between them freely.</p>

<p><img src="/quentier/Welcome_to_Quentier.png" alt="Welcome to Quentier" /></p>

<p>To add a new account, open File menu -&gt; Switch account -&gt; Add account. You will be prompted which kind of account you want to create - either local one or Evernote one.</p>

<p><img src="/quentier/Quentier_add_account.png" alt="Quentier add account" /></p>

<p>If you choose Evernote account you will be prompted the Evernote server to use: Evernote means the default server used by most casual users, Yinxiang Biji is Chinese Evernote server and Evernote sandbox is mostly useful to developers - it is Evernotes server with which the synchronization algorithms can be tested. After you choose the Evernote server to use youll be prompted to allow Quentier manage your Evernote accounts data.</p>

<p><img src="/quentier/Quentier_authenticate_to_Evernote.png" alt="Quentier authenticate to Evernote" /></p>

<p>It is also possible to manage the existing accounts: File -&gt; Switch account -&gt; Manage accounts. From the dialog you can add new accounts, revoke the authentication for particular Evernote accounts (might be useful in case of synchronization problems: revoking the authentication triggers authentication request on the next synchronization attempt) and even delete the account. Only use the latter option with great care because <strong>the removal of local accounts is permanent and cannot be reverted</strong>. The removal of Evernote account simply means unlinking Quentier from managing that account, not the permanent removal of your Evernote account, of course.</p>

<p>One other nice account-related feature is the ability to change the display name of any account - this current accounts display name is shown at the top of the main window. For example, for Evernote accounts your username would be displayed. You might want to change that to show your real name. Within Manage accounts dialog you can do so by entering your real name into the Display name column.</p>

<h3 id="user-interface">User interface</h3>

<p>On the upper part of the main window theres a toolbox with several buttons for most frequently used actions: synchronization (for Evernote accounts), printing of current note or exporting it to PDF, deletion of current note or creation of a new one.</p>

<p><img src="/quentier/Quentier_toolbar.png" alt="Quentier toolbar" /></p>

<p>This panel also contains the note search string which can be used to filter notes by some particular criteria. The search string fully supports the <a href="https://dev.evernote.com/doc/articles/search_grammar.php">Evernote search syntax</a>. The search string can be saved (as a saved search data item within the account) by pressing the button to the right from the search string.</p>

<p><img src="/quentier/Quentier_note_search_string.png" alt="Quentier note search string" /></p>

<p>On the left side of Quentiers main window there are panels displaying notebooks, tags, saved searches, favorited items and deleted notes. By default the deleted notes are not displayed but the display of them - as well as the display of all other side panels - can be toggled using the appropriate option from View menu. The entire left side panel can be hidden for which theres a default keyboard shortcut - F10.</p>

<p><img src="/quentier/Quentier_left_panels.png" alt="Quentier left panels" /></p>

<p>Favorited items are similar to <a href="https://help.evernote.com/hc/en-us/articles/209004637-How-to-create-shortcuts">Evernote shortcuts</a>: they allow you to create links to most frequently used content - particular notes, notebooks, tags, saved searches - for quick access to them. However, favorited items are favorited only locally for either local or Evernote account because Evernote service doesnt offer any API for the synchronization of favorited items or shortcuts. Or no such public API at least. Quentier is not the only Evernote client which has to cope with this restriction, <a href="http://alternoteapp.com/">Alternote</a> app describes the issue within its <a href="http://alternoteapp.com/ru/#faq">FAQ</a>.</p>

<p>The list of notebooks is really a tree view as notebooks can be nested into stacks and linked notebooks are displayed as children of special items representing users owning the corresponding linked notebooks. Notebooks can be freely moved between stacks either via context-menu or via drag-n-drop. However, it is prohibited to, say, drop users own notebook onto the stack corresponding to some linked notebook. Or to attempt doing the same thing across different linked notebooks.</p>

<p>Tags also form a tree structure as they can be nested into each other. Plus, tags downloaded from linked notebooks are also shown under special items representing users owning the corresponding linked notebooks. Tags nesting can be altered either via context menu or via drag-n-drop, with the same restrictions as for notebooks.</p>

<p>Saved searches list is a simple list without any kind of nesting. The query corresponding to each saved search can be edited through that saved searchs context menu.</p>

<p>The list of deleted notes shows the notes which are still persisted within the local storage (and Evernote account) but are marked as deleted. Quentier doesnt allow the permanent removal of notes for Evernote accounts as Evernote service prohibits this possibility for third party apps. As well as the possibility to permanently remove a tag, a notebook or a saved search. It is quite a wise decision from Evernote as this way Quentier or any other third party app has no way to cause the data loss within your Evernote account - you can only potentially lose the data which has not been synced yet. Or, if you are very inattentive, you can mark the note as deleted from third party app and then wipe it from the trash can via the official Evernote client or via Evernote web client. So, pay attention when emptying the trash of Evernote notes - make sure theres nothing of worth there.</p>

<p>The next column from the left edge of the main window is the list of notes. Each item within the list shows some information about the note: its title, creation and modification time, preview text and the thumbnail. The thumbnails are only displayed for Evernote accounts if Show note thumbnails preference is enabled (it is by default) and if the synchronization setting Download note thumbnails is enabled (it is by default). At this time there is no note table view so note list view is the only way to observe the existing notes.</p>

<p><img src="/quentier/Quentier_note_list_view.png" alt="Quentier note list view" /></p>

<p>In the upper part of the note list view theres a widget called Filters, by default folded. To unfold it, press the button with left pointing arrow. The unfolded widget allows to enable filters for notes list: notebooks, tags or a saved search. The saved search filter overrides notebook and tag filters: the latter ones become disabled (greyed out) to indicate they dont contribute to the actual filtering criteria - saved search - at the moment. Filters by notebooks, tags and saved search are all disabled when the note search string (on the upper panel, above the note editor) is not empty. I.e. filter by saved search overrides filters by notebooks and tags but note search string overrides just any filter.</p>

<p>Filtering notes by a single notebook works automatically by selecting the notebook within the list i.e. as you select different notebooks within the notebooks list, youd see notes from the selected notebook but not from other notebooks. Thats how the official Evernote clients work so it should be fairly convenient for Evernote users.</p>

<p>Currently theres a limitation on filtering by notebooks and tags: you cant filter the notes by linked notebooks and tags from linked notebooks. The reasons for this are purely technical and have to do with the potential clashing of notebook and/or tag names from users own account and from linked notebooks. This issue would hopefully be addressed in future.</p>

<p>Slightly below the filters widget theres a combo box allowing to pick the desired sorting criteria for the list of notes. By default the notes are sorted by modification time, the recently modified notes go first.</p>

<h3 id="note-editor">Note editor</h3>

<p>On the right side of the main window theres one or more tabbed note editors displaying the contents of notes. Quentier by default limits the amount of open note editors in order to prevent the use of ever growing amounts of memory. It happens automatically: if you open different notes one by one, the editors for previous notes (longest time untouched ones) automatically close. The unsaved edits made to notes within those editors are automatically saved, of course, so there is no risk of data loss. The only thing which is lost when the note editor is closed is the state of the undo stack i.e. the ability to do undo/redo for already closed note editors is gone.</p>

<p>Each note editor can be moved from tab to a separate window. For this right click on the note editor tabs header and choose Open in separate window option. However, beware that once you did this, the only way to return the note editor to the tabs list is to close it and open the same note again.</p>

<p>The attachments to notes (resources in Evernote terminology) are represented as either images (for image attachments) or small blocks containing the name and the size of the attachment and the buttons to save the attachment to some file or open the attachment for editing. If the attachment was opened for editing within some app, Quentier would watch for changes done by the app and once the attachment file changes, it would update the resource within the note. Unfortunately at the time of this writing it is not possible to choose the application which is to be used for editing of the attachment - it appears to be highly platform specific and no standard Qt API to implement that exists.</p>

<p>The image attachments can be rotated clockwise or counterclockwise and can be resized - for that put the cursor to the right bottom edge of the image and drag it.</p>

<p>The columns of tables within notes can be resized - simply put the cursor on the border between the columns and drag it.</p>

<p>The note editor supports a wide range of undo/redo capabilities - it tries hard to intercept every possible action and account for it within the undo/redo stack. The intercepted actions include text input as well as various other manual actions like rotating the image attachments - try to rotate the image attachment and then click Undo. Then click Redo. Now you see how it works.</p>

<p>The note editors undo stack implementation is one of the trickiest parts of the entire project. That means, it is unfortunately considerably fragile. If it doesnt work in some cases, please forgive it - it tries as hard as I was able to make it so. But in addition to forgiving it please file an issue on the projects <a href="https://github.com/d1vanov/quentier/issues">issue tracker</a> - unless the issue similar to the observed one has already been submitted.</p>

<p>Quentier supports encryption and decryption of note fragments, including both modern encryption used by Evernote - AES algorithm - and the legacy encryption algorithm - RC2. Unlike Nixnote 2, Quentier doesnt require Java for that: the encryption/decryption algorithms from OpenSSL are used instead. A side note for Mac users: Apples SSL implementation doesnt have these algorithms, thats why OpenSSL from Homebrew or Macports (or some custom OpenSSL build) is required to build libquentier and Quentier on Mac.</p>

<h3 id="features-present-in-official-evernote-apps-but-not-in-quentier">Features present in official Evernote apps but not in Quentier</h3>

<p>There are lots of them. Just about every single feature but the simplest notes, notebooks, tags and saved searches management is not implemented at this moment. Several features existing in Evernote look interesting so they might be added in future, for example, embedded PDFs within the note editor or <a href="https://help.evernote.com/hc/en-us/articles/209004967-How-to-create-import-folders-in-Evernote-for-Windows">import folders</a> functionality. However, I wont like to give the precise list of features planned for implementation in future as that would depend on a lot of things - on the degree of public interest to Quentier, on the amount of votes for this or that particular feature, on the technical difficulty to implement such a thing and on other factors.</p>

<p>Hopefully this post gives you some idea about what Quentier is capable of right now. If youd like to know more, give Quentier a try and evaluate its capabilities yourself.</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://d1vanov.github.io/quentier/blog/helloworld/">
        Hello world!
      </a>
    </h1>

    <span class="post-date">Dec 7, 2017</span>

    


    <p>This blog is dedicated to <a href="https://github.com/d1vanov/quentier">Quentier</a>  an open source desktop note taking app which can be used as Evernote client or just for local note taking without the necessity to even have the Evernote account. Quentier is free software distributed under the terms of GNU GPL v.3. The core functionality of Quentier is encapsulated in <a href="https://github.com/d1vanov/libquentier">libquentier</a> library which is distributed under the terms of GNU LGPL v.3.</p>

<p>Let me briefly introduce myself as the author of Quentier: my name is Dmitry Ivanov, I&rsquo;m a 29 years old software developer from Saint-Petersburg, Russia. I bet I&rsquo;m not (yet) known to the free software community as my contributions to free software in the past were quite limited. Quentier is my &ldquo;pet project&rdquo; on which I&rsquo;ve been working in my free time for several last years. There is no any company or organization behind the project.</p>

<p>Here&rsquo;s how Quentier looks like:</p>

<p><img src="/quentier/Quentier_sample_screenshot.png" alt="Sample Quentier screenshot" /></p>

<p>With Quentier you can read, modify, search and create notes, put them into notebooks, label them with tags, create and manage saved searches. If you are using Quentier for working with Evernote account, you can also synchronize with Evernote service - download the data into Quentier&rsquo;s local storage, work with the content and then send changes back to Evernote. With Quentier it is absolutely possible to create and edit content offline and synchronize it with Evernote later.</p>

<p>Compared to official Evernote clients for various platforms, Quentier is a rather minimalistic one: it doesn&rsquo;t have many advanced features such as <a href="https://help.evernote.com/hc/en-us/articles/209004967-How-to-create-import-folders-in-Evernote-for-Windows">import folders</a> or PDF reader embedded into the note editor or the possibility to e-mail notes right from the app. Some of such advanced functionality might (or might not) be added to Quentier in future. However, there are some notable already supported features required for proper working with already existing notes: for example, Quentier properly supports encryption and decryption of note fragments supporting both current encryption method used by Evernote - AES - and the older legacy one - RC2.</p>

<p>Quentier maintains most of the account&rsquo;s content within a local SQLite database which allows for convenient and efficient searching of stuff. Quentier fully supports Evernote search syntax as internally it is translated into SQL queries.</p>

<p>More details on what Quentier can and cannot do and how it works will be revealed in future posts so stay tuned. The rest of this post is dedicated to project&rsquo;s history and attempts to foresee and answer some questions expected from newcomers.</p>

<!-- more -->

<p>The Quentier project was open sourced only in late 2017 although it was started long before that, in the middle of 2013. At that time I had the following situation in my life  it was about half a year since I decided to abandon the PhD program I was participating and about a year since I got permanent job of a junior software developer. My education had little to do with software development, I was a theoretical physicist and just did some mathematical modeling in Fortran. Shortly before my graduation one of my university teachers moved to a rather young company to start a new department there and he offered me to become his assistant. The job had no connection to physics at all but it was connected to mathematical modeling so I agreed. I was working part time for about a year as after my graduation I entered the PhD program. But that program didn&rsquo;t work out well for me so I quit it at some point and decided to start working full time. My employer agreed under condition that I&rsquo;d take some purely programming tasks not involving math in addition to my previous duties.</p>

<p>Shortly after starting to work on purely programming tasks I realized I lack the expertise required to solve such problems efficiently and decided to learn programming to become a more proficient developer. I started to read various books on software development but I felt it was not enough  I needed practice as well as theory and the practice I had at work wasn&rsquo;t quite enough since it was mostly about maintaining already existing working code and I tried really hard to change it minimally to not break things. So I decided to start some hobby project to work on in my free time  such project could serve as a playground for various ideas on software design which I read from books and articles as well as the ongoing source of learning various things which I&rsquo;d need to master for the project&rsquo;s completion.</p>

<p>Many people finding themselves in a similar situation seem to settle with small projects like various ToDo lists or small scripts or something similar. Other folks go for various exercises which can be found in great numbers on the Internet. Others go further and take some programming courses. I didn&rsquo;t want to participate in any courses but wanted to build something mildly complex and actually useful myself. That desire was backed by my introduction to Linux and the world of free software which happened in 2012. I became very enthusiastic about the ideas of free software and wanted to participate in its development somehow. So I did intend to open source my pet project if it ever reaches usable state.</p>

<p>By the time I switched my home computer from Windows to Linux (in 2012) I already used <a href="https://evernote.com">Evernote</a> service  I didn&rsquo;t use it very often or very much but I found it very convenient for note taking and syncing across several computers. So when I found out there is no official Evernote client for Linux, it was a disappointment. I tried Everpad and Nevernote (or Nixnote 1, the Evernote client in Java with Qt bindings) but neither seemed good enough for me. So after some thought I decided to devote my pet project to the creation of something like Evernote client for Linux myself. You can judge by that decision how much junior I was at the time as I could not even roughly estimate the scale of the task. If I realized how huge it was back then, you would have probably never heard of Quentier as it won&rsquo;t have ever been even started.</p>

<p>Coincidentally around the time I decided to start Quentier project I also started to tinker with the <a href="https://www.qt.io">Qt framework</a>. At work I developed things in C++ but no Qt. I learned about Qt framework&rsquo;s existence somewehere on KDE forums and decided that&rsquo;s just what I need for writing GUI apps in C++ which would also be cross-platform.</p>

<p>So the pet project&rsquo;s technological set was mostly determined  Qt and C++. I need to master C++ because that&rsquo;s what I code in at work and I need Qt if I want to make nice cross-platform apps. One other piece of technology I learned about from watching the KDE project was <a href="https://cmake.org/">CMake</a> build system. From a brief look it seemed much more powerful than <a href="http://doc.qt.io/qt-5/qmake-manual.html">qmake</a> so I decided to learn and use it.</p>

<p>One might ask why I didn&rsquo;t come to help build <a href="https://github.com/baumgarr/nixnote2">Nixnote 2</a> instead as it also used Qt and C++. The answer is simple  I had no idea of Nixnote 2&rsquo;s existence. I&rsquo;ll return to discussing Nixnote 2 a bit later in this post.</p>

<p>So in the second half of 2013 I created a private repository on <a href="https://bitbucket.org">bitbucket</a> and started to tinker with the official <a href="https://github.com/evernote/evernote-sdk-cpp">Evernote C++ SDK</a> and its dependencies trying to put something together. I had little idea of how to structure whatever I was building so for the first 7-8 months I just did random things like the main window&rsquo;s UI created in Qt Designer, some basic note editor based on <code>QTextEdit</code> and <code>QTextDocument</code> and various other small things. After I realized I have no idea where I&rsquo;m going I decided to put the code aside and try to come up with some high level architecture which I would then implement piece by piece. After some thought I figured there are just three large required components interacting with each other:</p>

<ol>
<li>Local storage</li>
<li>Synchronization</li>
<li>GUI</li>
</ol>

<p>Fortunately, by that time I learned some basics about multithreading and figured that operations with local storage and synchronizaton should be done in background threads and not block the UI thread. So the threading model was also quite simple initially: local storage controller runs in its own thread, the synchronization controller also runs in its own thread and they communicate with each other and with GUI asynchronously, by sending data via signals and slots.</p>

<p>Once that concept was worked out, I started to implement the local storage part. Quick googling revealed the industry standard for embedded databases is <a href="https://www.sqlite.org/">SQLite</a> so I read a book on SQL basics in context of SQLite and got to coding. Fortunately, I was aware of <code>QtSql</code> module&rsquo;s existence which simplified the coding of database management for me.</p>

<p>Shortly after I started to implement the local storage component I learned about the existence of <a href="https://github.com/d1vanov/QEverCloud">QEverCloud</a>  the amazing Qt-friendly replacement for the official Evernote C++ SDK which was quite a pain to use  first, it had a fair share of dependencies including thrift library, some boost parts, libevent and something else which I don&rsquo;t even remember now; second, the use of the official Evernote C++ SDK involved a lot of conversions between <code>std::string</code> and <code>QString</code> which was of course nothing good. I rejoiced and converted my project to use <code>QEverCloud</code>.</p>

<p>A little later, when about 60% of the known work on the local storage was done, I occasionally learned about the existence of Nixnote 2. It felt to match exactly the niche of my project and even used the same technological stack  C++ and Qt. I was very disappointed and considered shutting my project down and switching to doing something else. For a couple of weeks I ceased the development of Quentier and tried to use Nixnote 2. At that time  mid 2014 if I remember correctly  it was quite buggy. Out of curiosity I decided to look at the source code and find the origin of some bugs which prevented me from using the app normally. I have properly traced the roots for a couple of issues and even <a href="https://github.com/baumgarr/nixnote2/pull/19">contributed</a> a simple fix for one bug. I saw a lot of interesting things within the source code of Nixnote 2 about the existence of which I had no idea previously. One thing which later affected the development of Quentier was the use of <code>QtWebKit</code> as the note editor&rsquo;s backend. My previous attempts to build the note editor were focused on employing <code>QTextEdit</code> and <code>QTextDocument</code> for that and there were quite several problems which I wasn&rsquo;t sure how to handle, for example, what to do with HTML elements which <code>QTextDocument</code> doesn&rsquo;t support but which might appear within Evernote&rsquo;s notes  there are not many such elements but they exist so just ignoring them was not an option. Furthermore, it was unclear how to embed the resources (attachments) within the note&rsquo;s text. <code>QtWebKit</code> solved both mentioned problems nicely  being the browser engine it supported HTML much better out of the box + there was a nice piece of API for the insertion of custom widgets into the page  web plugins. That was a perfect match for displaying of attachments embedded into notes.</p>

<p>I need to take a brief stop here to tell about my opinion and impression on Nixnote 2 and its author. I greatly admire the time and effort put into the development of Nixnote 2 by its author, <a href="https://github.com/baumgarr">baumgarr</a>. He was also the author of Nixnote 1 also known as Nevernote  the free open source Evernote client implemented in Java with Qt bindings. Its first version was <a href="https://discussion.evernote.com/topic/7943-linux-guinea-pigs/">announced</a> in late 2009 and for all these years till now baumgarr has been devoting his free time and effort into building Nevernote and then Nixnote 2. The years of dedicated volunteer job deserve a lot of respect.</p>

<p>However I must confess that I consider several engineering solutions implemented in Nixnote 2 corner-cutting shortcuts and oversimplifications for the increased speed of development. I&rsquo;ll mention some of them here, for completeness:</p>

<ul>
<li>The first such shortcut is the use of <code>QSqlTableModel</code> and relatives. These Qt classes are indeed very convenient but they talk to the SQLite database synchronously, in the UI thread. For large enough databases that has the potential to totally screw up the performance.</li>
<li>The second shortcut is the use of global variables. Nixnote 2 has a special class globals which mostly consists of a bunch of different app settings. It is used a lot across the whole code of the app. Everybody knows why global variables are bad  they tighten the binding between components and thus increase the potential for the code to become spaghetti.</li>
<li>The third shortcut is the ad-hoc style of conversions between ENML and HTML representations of the note. The conversion is basically just a linear search and replace of some pre-specified markup fragments. The proper approach as I see it should involve iterating over the DOM tree of the HTML document and working with its elements, attributes and their contents. That is what I implemented in <a href="https://github.com/d1vanov/libquentier">libquentier</a> (the core library of Quentier). I did it using the conversion of HTML to a valid XML and then using Qt&rsquo;s standard XML reading/writing facilities. Nixnote 2 could do the same because it also uses HTML tidy  the tool capable of making HTML a well formed XML. Speaking of which, originally Nixnote 2 used the tool via launching it as another process which is not quite as performant as making library calls  several months ago such option was added to Nixnote 2.</li>
</ul>

<p>I could continue this list but I&rsquo;d stop here as that&rsquo;s enough to briefly represent my view on Nixnote 2&rsquo;s engineering issues. Despite these issues Nixnote 2 has nevertheless become successful  it has been included into Debian which does mean something in my opinion. Currently it is much more stable and usable than it was years ago.</p>

<p>Returning back to my story, I decided to continue the development of Quentier. Beyond the lack of ensureness in Nixnote 2&rsquo;s success the determining factors in my decision were the following:</p>

<ol>
<li>For the end user of the software it never hurts to have a choice so the existence of Nixnote 2 doesn&rsquo;t mean Quentier won&rsquo;t be needed by anyone ever.</li>
<li>Quentier still nicely plays the role of a playground project for self-learning.</li>
<li>I also realized that having a finished pet project capable of doing something useful would be a very nice portfolio item should I decide to change job.</li>
</ol>

<p>I&rsquo;d like to specifically note that I decided to not copy-paste any code from Nixnote 2 even though it was written in C++ and used Qt. The rationale was the following:</p>

<ol>
<li>Nixnote 2 is licensed under GPL and I wanted to have the core library licensed under LGPL.</li>
<li>If I start to copy-paste someone else&rsquo;s code, that would diminish the self-learning role of the project.</li>
</ol>

<p>I learned a lot from viewing the progress of Nixnote 2  I watched its GitHub repository, saw problems which users encountered and features they wanted and suggested. It taught me a lot and some of that knowledge was shamelessly used in Quentier project.</p>

<p>Shortly after my decision to continue the work on Quentier despite the existence of Nixnote 2 I learned that the original author of QEverCloud library decided to resign from maintaining it. As by that time a lot of my code depended on QEverCloud I decided to volunteer becoming the next maintainer. I got the blessing from the original author as well as the code used to produce the auto-generated headers and sources of QEverCloud  <a href="https://github.com/d1vanov/QEverCloudGenerator">QEverCloudGenerator</a>. One thing I felt QEverCloud is lacking is the ability to be used as a shared library so I added such support. Another thing I did was the switch from <code>qmake</code> build system to <code>CMake</code>.</p>

<p>A major milestone in Quentier development was finalizing the local storage management and covering it with unit tests. The coverage is still not 100% but it is rather good. The hardest part of the entire development, I think, was implementing the Evernote search syntax support within the local storage. I guess finishing it (and covering with tests) was the absolute point of no return after which the sunk cost psychology would not let me cease the development no matter what happens.</p>

<p>The next thing to implement after the local storage which I chose to do was the note editor. I started it from scratch using <code>QtWebKit</code> as the backend. As a lot of stuff about HTML, CSS and JavaScript was new to me, I progressed quite slowly and had to read a lot of literature to make myself familiar with the basics of these technologies. I&rsquo;ve even read David Flanagan&rsquo;s Javascript. The definitive guide  a huge manuscript of ~1500 pages covering a whole lot of information. After several months of work I had some basic note editor with support for resources (attachments to notes) and simple actions like font size/family adjustment and stuff like that. I should have probably stopped at this for the first version but I didnt. Instead I decided to implement smart undo/redo support for the note editor and some other fancy things like the support for resizable table columns. It all took several more months of work, involved a fair share of scripting but the end result got me really proud.</p>

<p>Unfortunately, there was another disappointment waiting for me just around the corner: Qt decided to deprecate <code>QtWebKit</code> module in favour of newish <code>QtWebEngine</code>. The more I learned about the differences between the two web modules the more frustrated I became: <code>QtWebEngine</code> was almost entirely asynchronous unlike the synchronous <code>QtWebKit</code> but much worse was another fact: the entire web plugin based API was missing in <code>QtWebEngine</code>. The official statement was like with HTML5 nobody needs web plugins anymore. Aha, sure. Probably I should have just ignored that deprecation but I once again couldnt resist the challenge and spent several more months supporting <code>QtWebEngine</code> backend in addition to <code>QtWebKit</code>. For <code>QtWebEngine</code> I replaced web plugins with programmatically generated resource (attachment) representing images which were also additionally scripted to catch the clicks on Open and Save buttons rendered on them.</p>

<p>As a result of supporting both <code>QtWebKit</code> and <code>QtWebEngine</code> the source code of the note editor has become the messiest code of the entire project. It is full of <code>ifdef</code>s splitting the pieces of logics required for different backends plus I did a lot of things via JavaScript even when <code>QtWebKit</code> and <code>QtWebEngine</code> had some incompatible C++ APIs for them  they were too different + most C++ APIs for <code>QtWebEngine</code> appear only in the latest and greatest versions of Qt5 while I wanted to keep compatibility with as many Qt versions as possible.</p>

<p>The rest of Quentiers development after the note editor was much less dramatic which was very fortunate for me since I started to get really tired of all these unexpected issues. I implemented the synchronization logics but before I could test it properly I needed to implement the rest of UI components and piece them together to form the bulk of the app which one can interact with. I decided to use Qts model-view framework for lists of notebooks, notes, tags etc. Notebooks and tags are actually represented by tree models: notebooks can be nested into stacks + they can correspond to linked notebooks instead of users own account; tags can be nested into each other + they can also come from linked notebooks notes. Implementing models and some custom delegates took several months but it was worth it: now I feel like <code>QAbstractItemModel</code> is my best understood part of Qt framework.</p>

<p>I first compiled the pieces together into an app in the beginning of 2017 and the rest of the year was spent on implementing various small missing pieces of functionality and troubleshooting. Finally the whole thing was published on GitHub.</p>

<p>Looking back now I can see the history of Quentier project is full of operational mistakes: I should have studied the landscape better and found out about the existence of Nixnote 2 much earlier, ideally before I started to tinker with anything. I should have invested more effort into building the high level design of the app in the very beginning of the project. Finally, once I had some blueprint I should have probably started to develop things in public  that might have attracted people with good suggestions and skills. If I ever start any open source project again, Ill definitely try to avoid the same mistakes. Hopefully someone would be able to avoid such mistakes after reading about my experience.</p>

<p>A logical conclusion to this post would be some estimation about the future of Quentier project. I plan to continue working on it but I might have to slow down a little because Ive accumulated some technical debt in my life during several previous years of development and I need to &ldquo;pay&rdquo; it now. I really hope someone would join the development, at least in the form of bug reports and maybe patches. I would also enjoy to see someone willing to work on some new functionality and improving the existing one as well. So what I definitely intend to do is to make the project as developer-friendly as possible: write more developer docs, especially the introductory ones + factor out some junior jobs and mark them appropriately. Then time will tell whether there&rsquo;s any public interest in Quentier: if the project manages to attract both developers and users, it&rsquo;s development would most likely continue even if I choose to step aside (although right now I don&rsquo;t have such plans).</p>

<p>Also one more note about Quentier&rsquo;s potential connections with Nixnote 2: even though playing on the same field makes us competitors, Im not really a person who is into competition. I would much rather collaborate than compete. I think the appearance of Quentier is good for Nixnote 2 since it can definitely take some pieces from it, for example, the C++ code for encrypting/decrypting the note fragments. Currently Nixnote 2 still requires Java only for that functionality. To foresee the next question, I dont think it would be possible to merge the two projects together: after all, they are very different architecturally. But I think these two projects can definitely become good neighbours.</p>

<p>I guess that&rsquo;s more than enough for the introductory post. I plan to write more on many things which I feel should be communicated so stay tuned.</p>

  </div>
  
  
</div>


  </body>
</html>
