language: cpp

sudo: required
dist: xenial
services:
        - xvfb

branches:
    only:
        - master
        - development

matrix:
    include:
        - os: linux
          env: QT_BASE=551 COMPILER=g++-5.4 CMAKE_BUILD_TYPE=Debug

        - os: linux
          env: QT_BASE=551 COMPILER=clang++ CMAKE_BUILD_TYPE=Debug

        - os: linux
          env: QT_BASE=5123 COMPILER=g++-5.4 CMAKE_BUILD_TYPE=RelWithDebInfo CLANG_FORMAT_CHECK=1

        - os: linux
          env: QT_BASE=5123 COMPILER=clang++ CMAKE_BUILD_TYPE=Debug

        - os: osx
          env: CMAKE_BUILD_TYPE=RelWithDebInfo
          compiler: clang

before_install:
    - |
      export CHANGED_FILES=($(git diff --name-only ${TRAVIS_COMMIT_RANGE})) &&
      echo "Changed files: ${CHANGED_FILES}" &&
      export DETECTED_CHANGES_AFFECTING_BUILD=False &&
      for CHANGED_FILE in ${CHANGED_FILES}; do
        echo "Checking file ${CHANGED_FILE}" &&
        if ! [[ ${CHANGED_FILE} =~ "*.md" ]] && [[ "${CHANGED_FILE}" != "COPYING" ]]; then
          echo "Detected changes affecting build: file ${CHANGED_FILE}" &&
          DETECTED_CHANGES_AFFECTING_BUILD=True &&
          break
        fi
      done
    - |
      if [[ ${DETECTED_CHANGES_AFFECTING_BUILD} == False ]]; then
        if [ -z "$TRAVIS_TAG" ]; then
          echo "No changes affecting build detected, exiting" &&
          travis_terminate 0 &&
          exit 1
        fi
      fi

install:
    - |
      if [ "${TRAVIS_OS_NAME}" = "linux" ]; then
        export DISPLAY=:99.0 &&
        wget http://www.cmake.org/files/v3.2/cmake-3.2.0-Linux-x86_64.tar.gz &&
        tar -xzf cmake-3.2.0-Linux-x86_64.tar.gz &&
        sudo cp -fR cmake-3.2.0-Linux-x86_64/* /usr &&
        sudo apt-get -qq install libxml2-dev libboost-dev libssl-dev libhunspell-dev ninja-build &&
        sudo apt-add-repository -y ppa:ubuntu-toolchain-r/test &&
        if [ "${QT_BASE}" = "5123" ] && [ "${COMPILER}" = "g++-5.4" ]; then
          sudo apt-get -qq install appstream &&
          wget -c -nv "https://github.com/probonopd/linuxdeployqt/releases/download/6/linuxdeployqt-6-x86_64.AppImage" &&
          sudo mv linuxdeployqt-6-x86_64.AppImage /usr/local/bin/linuxdeployqt &&
          sudo chmod a+x /usr/local/bin/linuxdeployqt &&
          wget https://nixos.org/releases/patchelf/patchelf-0.9/patchelf-0.9.tar.bz2 &&
          tar xf patchelf-0.9.tar.bz2 &&
          cd patchelf-0.9 &&
          ./configure &&
          make &&
          sudo make install &&
          cd .. &&
          sudo wget -c "https://github.com/probonopd/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage" -O /usr/local/bin/appimagetool &&
          sudo chmod a+x /usr/local/bin/appimagetool
        fi
        if [ "${QT_BASE}" = "551" ]; then
          echo "Building for Qt 5.5.1" &&
          sudo apt-get -qq install qtbase5-dev qttools5-dev qttools5-dev-tools libqt5webkit5-dev libqt5sql5-sqlite &&
          if [ "${COMPILER}" = "clang++" ]; then
            export CXX="clang++" &&
            export CC="clang"
          fi
        else
          echo "Building for Qt 5.12.3" &&
          sudo apt-add-repository -y ppa:beineri/opt-qt-5.12.3-xenial &&
          travis_wait 30 sudo apt-get -qq update &&
          sudo apt-get -qq install qt512tools qt512base qt512webchannel qt512webengine qt512websockets qt512xmlpatterns qt512translations qt512svg mesa-common-dev libgl1-mesa-dev &&
          if [ "${COMPILER}" = "clang++" ]; then
            export CXX="clang++" &&
            export CC="clang"
          fi
        fi
        if [ "${QT_BASE}" = "5123" ] && [ "${COMPILER}" = "g++-5.4" ]; then
          git clone https://github.com/antony-jr/AppImageUpdaterBridge.git &&
          cd AppImageUpdaterBridge &&
          git checkout v1.1.8 &&
          mkdir build &&
          cd build &&
          cmake -G Ninja -DCMAKE_INSTALL_PREFIX=$(pwd)/installdir -DCMAKE_PREFIX_PATH=/opt/qt512 .. &&
          ninja &&
          ninja install &&
          export APPIMAGE_UPDATER_BRIDGE_DIR=$(pwd)/installdir/lib/cmake/AppImageUpdaterBridge &&
          cd ../..
        fi
        if [ "${CLANG_FORMAT_CHECK}" = "1" ]; then
          mkdir -p /tmp/clang-format &&
          curl -Ls "https://github.com/muttleyxd/clang-format-static-binaries/releases/download/master-5b56bb49/clang-format-10_linux-amd64" -o "/tmp/clang-format/clang-format" &&
          chmod +x /tmp/clang-format/clang-format &&
          export PATH=/tmp/clang-format:$PATH
        fi
      else
        brew update &&
        brew unlink cmake &&
        brew install cmake &&
        brew link cmake &&
        brew install qt5 &&
        brew install ninja &&
        chmod -R 755 /usr/local/opt/qt5/* &&
        brew install hunspell &&
        brew install tidy-html5 &&
        brew install p7zip
      fi
    - export QUENTIER_DIR=$(pwd) &&
      echo "QUENTIER_DIR = $QUENTIER_DIR"
    - cmake --version
    - cd ..
    - |
      if [ "${TRAVIS_OS_NAME}" = "linux" ]; then
        echo "Building breakpad" &&
        mkdir breakpad &&
        git clone https://chromium.googlesource.com/breakpad/breakpad &&
        cd breakpad &&
        git checkout chrome_64 &&
        git clone https://chromium.googlesource.com/linux-syscall-support src/third_party/lss &&
        ./configure --prefix=$(pwd)/installdir &&
        make &&
        make install &&
        export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(pwd)/installdir/lib &&
        cd ..
      fi
    - |
      echo "Building qtkeychain" &&
      mkdir qtkeychain &&
      git clone https://github.com/frankosterfeld/qtkeychain.git qtkeychain &&
      cd qtkeychain &&
      if [ "${QT_BASE}" = "5123" ]; then
        git checkout v0.9.1
      else
        git checkout v0.8.0
      fi
      mkdir build &&
      cd build &&
      if [ "${TRAVIS_OS_NAME}" = "linux" ]; then
        if [ "${QT_BASE}" = "5123" ]; then
          source /opt/qt512/bin/qt512-env.sh &&
          cmake -G Ninja -DCMAKE_INSTALL_PREFIX=$(pwd)/installdir -DCMAKE_PREFIX_PATH=/opt/qt512 ..
        else
          cmake -G Ninja -DCMAKE_INSTALL_PREFIX=$(pwd)/installdir ..
        fi
      else
        cmake -G Ninja -DCMAKE_INSTALL_PREFIX=$(pwd)/installdir -DCMAKE_PREFIX_PATH=/usr/local/opt/qt5 ..
      fi
      ninja &&
      sudo ninja install &&
      export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(pwd)/installdir/lib/x86_64-linux-gnu &&
      cd ../..
    - |
      if [ "${TRAVIS_OS_NAME}" = "linux" ]; then
        echo "Building tidy-html5" &&
        mkdir tidy-html5 &&
        git clone https://github.com/htacg/tidy-html5.git tidy-html5 &&
        cd tidy-html5 &&
        git checkout 5.6.0 &&
        mkdir build-tidy &&
        cd build-tidy &&
        cmake -G Ninja -DCMAKE_INSTALL_PREFIX=$(pwd)/installdir .. &&
        ninja &&
        ninja install &&
        export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(pwd)/installdir/lib &&
        cd ../..
      fi
    - |
      echo "Building QEverCloud" &&
      mkdir QEverCloud &&
      git clone https://github.com/d1vanov/QEverCloud.git QEverCloud &&
      cd QEverCloud &&
      if [ "${TRAVIS_BRANCH}" = "development" ]; then
        git checkout development
      fi
      mkdir build &&
      cd build &&
      if [ "${TRAVIS_OS_NAME}" = "linux" ]; then
        if [ "${QT_BASE}" = "5123" ]; then
          source /opt/qt512/bin/qt512-env.sh &&
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/qt512/lib &&
          cmake -G Ninja -DCMAKE_INSTALL_PREFIX=$(pwd)/installdir -DCMAKE_PREFIX_PATH=/opt/qt512 ..
        else
          cmake -G Ninja -DCMAKE_INSTALL_PREFIX=$(pwd)/installdir -DUSE_QT5_WEBKIT=1 ..
        fi
      else
        cmake -G Ninja -DCMAKE_INSTALL_PREFIX=$(pwd)/installdir -DCMAKE_PREFIX_PATH=/usr/local/opt/qt5 ..
      fi
      ninja &&
      ninja check &&
      ninja install &&
      export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(pwd)/installdir/lib &&
      cd ../..
    - |
      echo "Building libquentier" &&
      mkdir libquentier &&
      git clone https://github.com/d1vanov/libquentier.git libquentier &&
      cd libquentier &&
      if [ "${TRAVIS_BRANCH}" = "development" ]; then
        git checkout development
      fi
      mkdir build &&
      cd build &&
      if [ "${TRAVIS_OS_NAME}" = "linux" ]; then
        if [ "${QT_BASE}" = "5123" ]; then
          source /opt/qt512/bin/qt512-env.sh &&
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/qt512/lib &&
          cmake -G Ninja -DCMAKE_INSTALL_PREFIX=$(pwd)/installdir \
                -DQt5Keychain_DIR=$(pwd)/../../qtkeychain/build/installdir/lib/x86_64-linux-gnu/cmake/Qt5Keychain \
                -DQEverCloud-qt5_DIR=$(pwd)/../../QEverCloud/build/installdir/lib/cmake/QEverCloud-qt5 \
                -DTIDY_HTML5_INCLUDE_DIR=$(pwd)/../../tidy-html5/build-tidy/installdir/include \
                -DTIDY_HTML5_LIBRARIES=$(pwd)/../../tidy-html5/build-tidy/installdir/lib/libtidy.so \
                -DCMAKE_VERBOSE_MAKEFILE=ON -DCMAKE_PREFIX_PATH=/opt/qt512 ..
        else
          cmake -G Ninja -DCMAKE_INSTALL_PREFIX=$(pwd)/installdir \
                -DQt5Keychain_DIR=$(pwd)/../../qtkeychain/build/installdir/lib/x86_64-linux-gnu/cmake/Qt5Keychain \
                -DQEverCloud-qt5_DIR=$(pwd)/../../QEverCloud/build/installdir/lib/cmake/QEverCloud-qt5 \
                -DTIDY_HTML5_INCLUDE_DIR=$(pwd)/../../tidy-html5/build-tidy/installdir/include \
                -DTIDY_HTML5_LIBRARIES=$(pwd)/../../tidy-html5/build-tidy/installdir/lib/libtidy.so \
                -DCMAKE_VERBOSE_MAKEFILE=ON -DUSE_QT5_WEBKIT=1 ..
        fi
        export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(pwd)/installdir/lib &&
        echo "LD_LIBRARY_PATH = $LD_LIBRARY_PATH"
      else
        cmake -G Ninja -DCMAKE_INSTALL_PREFIX=$(pwd)/installdir \
              -DCMAKE_PREFIX_PATH=/usr/local/opt/qt5 \
              -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl \
              -DQt5Keychain_DIR=$(pwd)/../../qtkeychain/build/installdir/lib/cmake/Qt5Keychain \
              -DQEverCloud-qt5_DIR=$(pwd)/../../QEverCloud/build/installdir/lib/cmake/QEverCloud-qt5 \
              -DTIDY_HTML5_INCLUDE_DIR=/usr/local/include \
              -DTIDY_HTML5_LIBRARIES=/usr/local/lib/libtidy.dylib \
              -DCMAKE_VERBOSE_MAKEFILE=ON ..
      fi
      ninja &&
      ninja check &&
      ninja lupdate &&
      ninja lrelease &&
      ninja install
    - |
      if [ "${TRAVIS_OS_NAME}" = "linux" ]; then
        export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(pwd)/installdir/lib
      fi
    - |
      if [ "${TRAVIS_OS_NAME}" = "linux" ] && [ "${QT_BASE}" = "5123" ] && [ "${COMPILER}" = "g++-5.4" ] && [ "${TRAVIS_BRANCH}" = "development" ]; then
        echo "Triggering build at OpenSUSE build service for development branch" &&
        curl -X POST -H "Authorization: Token $OSC_TOKEN" https://api.opensuse.org/trigger/runservice?project=home%3Ad1vanov%3Aquentier-development&package=quentier-development
      fi

script:
    - |
      echo "Building quentier" &&
      cd $QUENTIER_DIR &&
      mkdir build &&
      cd build &&
      if [ "${TRAVIS_BRANCH}" = "master" ] || [ "${TRAVIS_BRANCH}" = "development" ]; then
        export INCLUDE_UPDATE_INFO=YES &&
        export DEFAULT_UPDATE_CHANNEL=$TRAVIS_BRANCH
      else
        export INCLUDE_UPDATE_INFO=NO &&
        export DEFAULT_UPDATE_CHANNEL=""
      fi
      if [ "${TRAVIS_OS_NAME}" = "linux" ]; then
        if [ "${QT_BASE}" = "5123" ]; then
          if [ "${COMPILER}" = "g++-5.4" ]; then
            cmake -G Ninja -DCMAKE_INSTALL_PREFIX=/usr \
                  -DCMAKE_INSTALL_TRANSLATIONSDIR=$(pwd)/appdir/usr \
                  -DLibquentier-qt5_DIR=$(pwd)/../../libquentier/build/installdir/lib/cmake/Libquentier-qt5 \
                  -DQt5Keychain_DIR=$(pwd)/../../qtkeychain/build/installdir/lib/x86_64-linux-gnu/cmake/Qt5Keychain \
                  -DQEverCloud-qt5_DIR=$(pwd)/../../QEverCloud/build/installdir/lib/cmake/QEverCloud-qt5 \
                  -DTIDY_HTML5_INCLUDE_DIR=$(pwd)/../../tidy-html5/build-tidy/installdir/include \
                  -DTIDY_HTML5_LIBRARIES=$(pwd)/../../tidy-html5/build-tidy/installdir/lib/libtidy.so \
                  -DBREAKPAD_ROOT=$(pwd)/../../breakpad/installdir \
                  -DQUENTIER_PACKAGED_AS_APP_IMAGE=ON -DCMAKE_PREFIX_PATH=/opt/qt512 -DBUILD_WITH_WIKI_TOOLS=1 \
                  -DINCLUDE_UPDATE_INFO=$INCLUDE_UPDATE_INFO \
                  -DDEFAULT_UPDATE_CHANNEL=$DEFAULT_UPDATE_CHANNEL \
                  -DDEFAULT_UPDATE_PROVIDER="APPIMAGE" \
                  -DAppImageUpdaterBridge_DIR=$APPIMAGE_UPDATER_BRIDGE_DIR \
                  ..
          else
            cmake -G Ninja -DCMAKE_INSTALL_PREFIX=$(pwd)/installdir \
                  -DLibquentier-qt5_DIR=$(pwd)/../../libquentier/build/installdir/lib/cmake/Libquentier-qt5 \
                  -DQt5Keychain_DIR=$(pwd)/../../qtkeychain/build/installdir/lib/x86_64-linux-gnu/cmake/Qt5Keychain \
                  -DQEverCloud-qt5_DIR=$(pwd)/../../QEverCloud/build/installdir/lib/cmake/QEverCloud-qt5 \
                  -DTIDY_HTML5_INCLUDE_DIR=$(pwd)/../../tidy-html5/build-tidy/installdir/include \
                  -DTIDY_HTML5_LIBRARIES=$(pwd)/../../tidy-html5/build-tidy/installdir/lib/libtidy.so \
                  -DBREAKPAD_ROOT=$(pwd)/../../breakpad/installdir \
                  -DCMAKE_PREFIX_PATH=/opt/qt512 ..
          fi
        else
          cmake -G Ninja -DCMAKE_INSTALL_PREFIX=$(pwd)/installdir \
                -DLibquentier-qt5_DIR=$(pwd)/../../libquentier/build/installdir/lib/cmake/Libquentier-qt5 \
                -DQt5Keychain_DIR=$(pwd)/../../qtkeychain/build/installdir/lib/x86_64-linux-gnu/cmake/Qt5Keychain \
                -DQEverCloud-qt5_DIR=$(pwd)/../../QEverCloud/build/installdir/lib/cmake/QEverCloud-qt5 \
                -DTIDY_HTML5_INCLUDE_DIR=$(pwd)/../../tidy-html5/build-tidy/installdir/include \
                -DTIDY_HTML5_LIBRARIES=$(pwd)/../../tidy-html5/build-tidy/installdir/lib/libtidy.so \
                -DBREAKPAD_ROOT=$(pwd)/../../breakpad/installdir \
                -DUSE_QT5_WEBKIT=1 ..
        fi
      else
        cmake -G Ninja -DCMAKE_INSTALL_PREFIX=$(pwd)/installdir \
              -DCMAKE_PREFIX_PATH=/usr/local/opt/qt5 \
              -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl \
              -DLibquentier-qt5_DIR=$(pwd)/../../libquentier/build/installdir/lib/cmake/Libquentier-qt5 \
              -DQt5Keychain_DIR=$(pwd)/../../qtkeychain/build/installdir/lib/cmake/Qt5Keychain \
              -DQEverCloud-qt5_DIR=$(pwd)/../../QEverCloud/build/installdir/lib/cmake/QEverCloud-qt5 \
              -DTIDY_HTML5_INCLUDE_DIR=/usr/local/include \
              -DTIDY_HTML5_LIBRARIES=/usr/local/lib/libtidy.dylib \
              -DCMAKE_VERBOSE_MAKEFILE=ON -DBUILD_WITH_WIKI_TOOLS=1 \
              -DINCLUDE_UPDATE_INFO=$INCLUDE_UPDATE_INFO \
              -DDEFAULT_UPDATE_CHANNEL=$DEFAULT_UPDATE_CHANNEL \
              -DDEFAULT_UPDATE_PROVIDER="GITHUB" \
              ..
      fi
    - ninja
    - ninja check
    - |
      if [ "${CLANG_FORMAT_CHECK}" = "1" ]; then
        echo "Building clang-format target" &&
        ninja clang-format &&
        dirty=$(git ls-files --modified) &&
        if [ ! -z $dirty ]; then
          echo "Detected source code files not formatted with clang-format " &&
          echo $dirty &&
          travis_terminate 1
        fi
      fi
    - ninja lupdate
    - ninja lrelease
    - |
      if [ "${TRAVIS_OS_NAME}" = "linux" ] && [ "${QT_BASE}" = "5123" ] && [ "${COMPILER}" = "g++-5.4" ]; then
        unset QTDIR &&
        unset QT_PLUGIN_PATH &&
        if [ "${TRAVIS_BRANCH}" = "master" ] || [ "${TRAVIS_BRANCH}" = "development" ]; then
          export VERSION=$TRAVIS_BRANCH
        else
          export VERSION=$(git rev-parse --short HEAD)
        fi
        DESTDIR=appdir ninja install &&
        linuxdeployqt appdir/usr/share/applications/*.desktop -bundle-non-qt-libs -extra-plugins=iconengines,imageformats -exclude-libs="libnss3.so,libnssutil3.so" &&
        mkdir -p appdir/usr/share/libquentier/translations &&
        cp -r ../../libquentier/build/installdir/share/libquentier/translations/*.qm appdir/usr/share/libquentier/translations/ &&
        if [ "${TRAVIS_BRANCH}" = "development" ]; then
          /usr/local/bin/appimagetool -n -u "gh-releases-zsync|d1vanov|quentier|continuous-development|Quentier*-x86_64.AppImage.zsync" appdir
        else
          /usr/local/bin/appimagetool -n -u "gh-releases-zsync|d1vanov|quentier|continuous-master|Quentier*-x86_64.AppImage.zsync" appdir
        fi
        find appdir -executable -type f -exec ldd {} \; | grep " => /usr" | cut -d " " -f 2-3 | sort | uniq
      else
        ninja install
      fi

after_success:
    - |
      if [ "${TRAVIS_OS_NAME}" = "linux" ] && [ "${QT_BASE}" = "5123" ] && [ "${COMPILER}" = "g++-5.4" ]; then
        if [ "${TRAVIS_BRANCH}" = "master" ] || [ "${TRAVIS_BRANCH}" = "development" ]; then
          wget https://github.com/d1vanov/ciuploadtool/releases/download/continuous-master/ciuploadtool_linux.zip &&
          unzip ciuploadtool_linux.zip &&
          chmod 755 ciuploadtool &&
          ./ciuploadtool -suffix="$TRAVIS_BRANCH" $QUENTIER_DIR/build/Quentier*.AppImage*
        fi
      elif [ "${TRAVIS_OS_NAME}" = "osx" ]; then
        if [ "${TRAVIS_BRANCH}" = "master" ] || [ "${TRAVIS_BRANCH}" = "development" ]; then
          cd $QUENTIER_DIR/build/installdir &&
          wget https://github.com/d1vanov/ciuploadtool/releases/download/continuous-master/ciuploadtool_mac.zip &&
          unzip ciuploadtool_mac.zip &&
          chmod 755 ciuploadtool &&
          7z a Quentier_mac_x86_64.zip quentier.app &&
          ./ciuploadtool -suffix="$TRAVIS_BRANCH" $QUENTIER_DIR/build/installdir/Quentier_mac_x86_64.zip
        fi
      fi
